---
title: "Data preparation"
author: "Pascale Caissy"
date: '2022-01-15'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library("tidyverse")
library("FactoMineR")
library("ggplot2")
library("ggfortify")
library("reshape2")
library("nlme")
library("vegan")
```


# Integrate missing variables
```{r gutcontent dataset}

jul.conv <- function(x) { 
  J <- julian( x, as.Date(paste0(format(x,"%Y"),"-01-01")))
  return(J[1])
}

prof_melange <- function(x){
  x <- x[!(is.na(x$Temp)),]
  for(l in 2:nrow(x)){
    r <- range(x$Temp[1:l], na.rm = TRUE)
    if(abs(diff(as.numeric(r))) > 0.5) {
      return(as.numeric(x$Pres[l]))
    }
    l = l+1
  }
  return(l-1)
}


gutcontent <- read.csv("Data/InputFiles_dataPrep/bosa stomach content_2020_01_07.csv", na.strings = "")  %>% select(-gear, -tow_type, -net_number, -mesh) %>% mutate(sampling_date = as.Date(sampling_date, "%Y-%m-%d"), date_gut_done = as.Date(date_gut_done, "%Y-%m-%d"))

str(gutcontent)
summary(gutcontent)

#add bu date
bu <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/Data - Sea Ice/bu.csv") %>% select(-X)
gutcontent2 <- merge(gutcontent, bu, by = c("region", "year"))


#treat CTD + zoo acoustic data + bosa biomass
station.CTD <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/station_list_PascaleCaissy_2021_01_16.csv", na.string = "")
test.CTD <- NULL
test.zoo <- NULL


for(i in 1:length(station.CTD$CTD_data_file)){
  print(paste("i =", i))
  vec.CTD <- c(strsplit(paste(station.CTD$CTD_data_file[i]), split =", "))[[1]]
  if(vec.CTD[1] == "NA"){
    test.CTD <- rbind(test.CTD, data.frame(station = station.CTD$station[i], sampling_date = station.CTD$sampling_date[i], max_fluo = NA, surf_sal_kgm3= NA, surf_temp_degC = NA, prof_mel = NA, cast_number = NA))
  } else{
    for (j in 1:length(vec.CTD)){
      file.dir.CTD <- paste("/Users/pascalecaissy/Dropbox/MSc 2019-2020/Data - CTD/int_I_need", strftime(station.CTD$sampling_date, format = "%Y")[i], vec.CTD[j], sep = "/")
      CTD <- read.table(file.dir.CTD, na.string = "NaN", skip = station.CTD$lines_to_skip[i], header = TRUE,stringsAsFactors = FALSE)
      CTD[1,] <- NA
      #trouver la zone de mÃ©lange
      z <- prof_melange(CTD)
      surf_sal_kgm3 <- mean(head(as.numeric(as.character(CTD$Sal)), n=z), na.rm = TRUE)
      surf_temp_degC <- mean(head(as.numeric(as.character(CTD$Temp)), n=z), na.rm = TRUE)
      max_fluo <- max(as.numeric(as.character(CTD$Fluo)), na.rm = TRUE)
      test.CTD <- rbind(test.CTD, data.frame(station = station.CTD$station[i], sampling_date = station.CTD$sampling_date[i], max_fluo = max_fluo, prof_mel = z, surf_sal_kgm3= surf_sal_kgm3, surf_temp_degC = surf_temp_degC, cast_number = j))
      j = j+1
    }
  }
  file.dir.zoo <- paste("/Users/pascalecaissy/Dropbox/MSc 2019-2020", station.CTD$acoustic_file_zoo[i], sep = "/")
  if(is.na(station.CTD$acoustic_file_zoo[i])) {
    test.zoo <- rbind(test.zoo, data.frame(station = station.CTD$station[i], sampling_date = station.CTD$sampling_date[i], NASC_zoo = NA))
  } else if (station.CTD$acoustic_file_zoo[i] == "Data - Acoustic/ZoopJen2018.csv") {
    zoo <- read.csv(file.dir.zoo) %>% filter(as.character(region) == as.character(station.CTD$region[i]))
    NASC_zoo = mean(zoo$NASC_Int, na.rm = TRUE)
    test.zoo <- rbind(test.zoo, data.frame(station = station.CTD$station[i], sampling_date = station.CTD$sampling_date[i], NASC_zoo = NASC_zoo))
  } else {
    zoo <- read.csv(file.dir.zoo)
    NASC_zoo = mean(zoo$PRC_NASC, na.rm = TRUE)
    test.zoo <- rbind(test.zoo, data.frame(station = station.CTD$station[i], sampling_date = station.CTD$sampling_date[i], NASC_zoo = NASC_zoo))
  }
  i=i+1
}



test.CTD2 <- aggregate(data = test.CTD, . ~ sampling_date + station, FUN = mean, na.action = na.pass)
test.CTD2$max_fluo[is.nan(test.CTD2$max_fluo)] <- NA

biomass <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/Data - Fish casts/net_data_CA_2021_01_16.csv")
CTDbiomass <- merge(test.CTD2, biomass, by = c("station","sampling_date"))

#CTD GL----
CTD.GL <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/Data - CTD/all/CTD_data_GL_20200107.csv")
zoo.GL.120 <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/Data - Acoustic/NEG/matrix120_leg1.csv") %>% select(-X)
zoo.GL.38 <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/Data - Acoustic/NEG/matrix38_leg1.csv") %>% select(-X)
station.GL <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/Data - Acoustic/NEG/GL Event log.csv")

zoo.GL <- zoo.GL.120
zoo.GL$Sv_mean_38 <- zoo.GL.38$Sv_mean
zoo.GL$deltaMVBS <- zoo.GL$Sv_mean-zoo.GL$Sv_mean_38

zoo.GL <- zoo.GL %>% filter(Depth_mean <=100 & Depth_mean >= 13.5, Lat_M > min(station.GL$LAT.N.decimal)-0.1 & Lat_M < max(station.GL$LAT.N.decimal)+0.1,Lon_M > min(station.GL$LONG.E.decimal*-1)-0.1 & Lon_M < max(station.GL$LONG.E.decimal*-1)+0.1) #0.1deg = 11.1km/6 miles nautiques
mean.NASC.GL <- mean(zoo.GL$NASC)

stationsGL <- unique(gutcontent[gutcontent$region == "NEG", c("station", "sampling_date")])
biomass.GL <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/Data - Fish casts/density_data_GL_20200304.csv") 
biomass.GL <- biomass.GL %>% mutate(sampling_date = as.Date(Date)) %>% filter(SDepthCat == "B")

test.GL <- NULL
for(i in stationsGL$station) {
  print(i)
  biomass <- biomass.GL[biomass.GL$Station == i, "bosa_dens_PC_indm.3"]
  CTD <- CTD.GL[CTD.GL$Stn == i,]
  z <- prof_melange(CTD)
  surf_sal_kgm3 <- mean(head(as.numeric(as.character(CTD$Sal)), n=z), na.rm = TRUE)
  surf_temp_degC <- mean(head(as.numeric(as.character(CTD$Temp)), n=z), na.rm = TRUE)
  test.GL <- rbind(test.GL, data.frame(station = i, sampling_date = as.factor(stationsGL[stationsGL$station == i, "sampling_date"]), max_fluo = -1000, prof_mel = z, surf_sal_kgm3= surf_sal_kgm3, surf_temp_degC = surf_temp_degC, max_sampling_depth = NA, indstandard = biomass ,NASC_zoo = mean.NASC.GL))
}

CTDzoobiomass <-  merge(CTDbiomass[,-7], test.zoo)
testALL <- rbind(CTDzoobiomass, test.GL)

gutcontent3 <- merge(gutcontent2, testALL)

#add open water day
gutcontent <- gutcontent3 %>% 
  mutate(open_water_day = sapply(sampling_date, FUN = jul.conv) - sapply(as.Date(bu_date), FUN = jul.conv)) 


```

# corriger les proies
```{r streamline gutcontent dataset}
#some larvae id may repeat themselves year after year
length(unique(gutcontent$larvae_id)) #I know I dissected 339 fish for now, so some ids are the same
gutcontent$unique_fish_id <- ifelse(gutcontent$region == "NEG", 
                                    paste("NEG", gutcontent$larvae_id, sep = "-"),
                                    paste(gutcontent$year, gutcontent$larvae_id, sep = "-"))

length(unique(gutcontent$unique_fish_id))

summary(gutcontent$standard_length)
missing.length <- gutcontent[is.na(gutcontent$standard_length), c("year", "region", "larvae_id", "preserved_standard_length", "comments")]
sum(is.na(gutcontent$standard_length))
missing.pres.length <- gutcontent[is.na(gutcontent$preserved_standard_length), c("year", "region", "larvae_id", "standard_length", "comments")]
sum(is.na(missing.pres.length$standard_length)) #even though i could not measure preserved length, i still have standard length

fish.with.SL <- aggregate(prey_id ~ unique_fish_id + standard_length + preserved_standard_length, data = gutcontent, FUN = length, na.action = na.pass)
plot(preserved_standard_length ~ standard_length, data = fish.with.SL) #seems robust
lm.SL <-lm(preserved_standard_length ~ standard_length, data = fish.with.SL)
summary(lm.SL)

test <- gutcontent %>% filter(is.na(standard_length)) %>% select(unique_fish_id) %>% filter(!duplicated(.$unique_fish_id))

gutcontent$est_standard_length <- ifelse(is.na(gutcontent$standard_length), (gutcontent$preserved_standard_length - lm.SL$coefficients[1])/lm.SL$coefficients[2], gutcontent$standard_length)
summary(gutcontent$est_standard_length)
all.equal(gutcontent$est_standard_length, gutcontent$standard_length) #seems to have worked and not just copied standard_length column
any(is.na(gutcontent$est_standard_length)) #no NA left
rm(fish.with.SL)

test <- gutcontent[is.na(gutcontent$height_anus), c("unique_fish_id","preserved_height_anus")] %>%filter(!duplicated(.$unique_fish_id))
test <- gutcontent[is.na(gutcontent$preserved_height_anus) & is.na(gutcontent$height_anus), c("unique_fish_id","preserved_height_anus")] %>%filter(!duplicated(.$unique_fish_id))

fish.with.HA <- aggregate(prey_id ~ unique_fish_id + height_anus + preserved_height_anus+standard_length, data = gutcontent, FUN = length, na.action = na.pass)

plot(preserved_height_anus ~ height_anus, data = fish.with.HA)
lm.HA <- lm(preserved_height_anus ~ height_anus, data = fish.with.HA)
summary(lm.HA)

plot(height_anus ~ standard_length, data = fish.with.HA)
lm.HASL <- lm(height_anus ~ standard_length, data = fish.with.HA)
summary(lm.HASL)

gutcontent$est_height_anus <- ifelse(is.na(gutcontent$height_anus) &!is.na(gutcontent$preserved_height_anus), (gutcontent$preserved_height_anus-lm.HA$coefficients[1])/lm.HA$coefficients[2], 
                                     ifelse(is.na(gutcontent$height_anus) &is.na(gutcontent$preserved_height_anus), (gutcontent$standard_length*lm.HASL$coefficients[2])+lm.HASL$coefficients[1],
                                            gutcontent$height_anus))
summary(gutcontent$est_height_anus)

#prey summary----
unique(gutcontent$prey_id)
gutcontent$prey_id <- as.character(gutcontent$prey_id)
gutcontent$prey_id[gutcontent$prey_id == " oithona similis"] <- "oithona similis"
gutcontent$prey_id[gutcontent$prey_id == "triconia sp"] <- "triconia borealis"
gutcontent$prey_id[gutcontent$prey_id == "egg "] <- "egg"
gutcontent$prey_id[gutcontent$prey_id == "microcalanus sp "] <- "microcalanus sp"
gutcontent$stade <- as.character(gutcontent$stade)
gutcontent$cop_or_naup[which(gutcontent$prey_id == "oithona similis" & is.na(gutcontent$cop_or_naup))] <- "c"
gutcontent$cop_or_naup[which(gutcontent$prey_id == "onceaidae sp" & is.na(gutcontent$cop_or_naup))] <- "c"
gutcontent$cop_or_naup[which(gutcontent$prey_id == "pseudocalanus sp" & is.na(gutcontent$cop_or_naup))] <- "c"
gutcontent$prey_length[which(gutcontent$prey_length == 4621)] <- 462
gutcontent$prey_id <-as.factor(gutcontent$prey_id)
gutcontent$prey_id <- droplevels(gutcontent$prey_id)
gutcontent$prey_id_nonstade <- ifelse(is.na(gutcontent$cop_or_naup) == FALSE, paste(gutcontent$prey_id, gutcontent$cop_or_naup, sep = " "), paste(gutcontent$prey_id))

gutcontent$prey_length <- ave(gutcontent$prey_length,gutcontent$prey_id_nonstade,FUN=function(x) 
  ifelse(is.na(x), mean(x,na.rm=TRUE), x))
gutcontent$prey_height <- ave(gutcontent$prey_height,gutcontent$prey_id_nonstade,FUN=function(x) 
  ifelse(is.na(x), mean(x,na.rm=TRUE), x))
unique(gutcontent$prey_id_nonstade)[order(unique(gutcontent$prey_id_nonstade))]

#assign unkowns to a species----
table(gutcontent$prey_id_nonstade)[c("unknown n", "unknown c")]
1572/24646 #6.3% unknown n
1870/24646 #7.6% unknown c
#C'est quand mÃªme substantiel comme nombre
gutcontent$is_it_fragment[which(is.na(gutcontent$is_it_fragment))] <- "N" 
table(gutcontent[gutcontent$prey_id_nonstade %in% c("unknown c", "unknown n"),c("prey_id_nonstade", "is_it_fragment")])
(1440+949)/(1572+1870)#most unknowns are fragments (~2/3)
range(gutcontent$prey_length[gutcontent$prey_id_nonstade %in% c("unknown c", "unknown n")], na.rm = TRUE)
range(gutcontent$prey_length[gutcontent$prey_id_nonstade %in% c("unknown c")], na.rm = TRUE)
range(gutcontent$prey_length[gutcontent$prey_id_nonstade %in% c("unknown n")], na.rm = TRUE)

gutcontent$prey_reass <- gutcontent$prey_id_nonstade

for(j in 1:3){
  for(i in 1:nrow(gutcontent)) {
    if(gutcontent$prey_reass[i] == "unknown n"){
      fishID <- gutcontent$unique_fish_id[i]
      samp_bag_all <- na.omit((gutcontent[gutcontent$unique_fish_id == fishID & gutcontent$cop_or_naup == "n", "prey_id_nonstade"]))
      samp_bag_medium <- na.omit((gutcontent[gutcontent$unique_fish_id == fishID & gutcontent$cop_or_naup == "n" & gutcontent$prey_length > 272, "prey_id_nonstade"]))
      samp_bag_big <- na.omit((gutcontent[gutcontent$unique_fish_id == fishID & gutcontent$cop_or_naup == "n" & gutcontent$prey_length > 462, "prey_id_nonstade"]))
      if(!length(samp_bag_all)){
        gutcontent$prey_reass[i] <- gutcontent$prey_reass[i]
      } else if(gutcontent$prey_length[i]>272 & gutcontent$prey_length[i] <= 462 & !!length(samp_bag_medium)){
        gutcontent$prey_reass[i] <- sample(samp_bag_medium, size = 1)
      } else if(gutcontent$prey_length[i]>272 & gutcontent$prey_length[i] <= 462 & !length(samp_bag_medium)){
        gutcontent$prey_reass[i] <- gutcontent$prey_reass[i] 
      } else if(gutcontent$prey_length[i] > 462 & !!length(samp_bag_big)){
        gutcontent$prey_reass[i] <- sample(samp_bag_big, size = 1)
      } else if(gutcontent$prey_length[i] > 462 & !length(samp_bag_big)){
        gutcontent$prey_reass[i] <- gutcontent$prey_reass[i]
      } else {
        gutcontent$prey_reass[i] <- sample(samp_bag_all, size = 1)
      }
    } else if(gutcontent$prey_reass[i] == "unknown c"){
      fishID <- gutcontent$unique_fish_id[i]
      samp_bag_all <- na.omit(gutcontent[gutcontent$unique_fish_id == fishID & gutcontent$cop_or_naup == "c", "prey_id_nonstade"])
      samp_bag_medium <- na.omit(gutcontent[gutcontent$unique_fish_id == fishID & gutcontent$cop_or_naup == "c" & gutcontent$prey_length > 600, "prey_id_nonstade"])
      samp_bag_big <- na.omit(gutcontent[gutcontent$unique_fish_id == fishID & gutcontent$cop_or_naup == "c" & gutcontent$prey_length > 1500, "prey_id_nonstade"]) 
      if(!length(samp_bag_all)){
        gutcontent$prey_reass[i] <- gutcontent$prey_reass[i]
      } else if(gutcontent$prey_length[i] > 600 & gutcontent$prey_length[i] <= 1500 & !!length(samp_bag_medium)){
        gutcontent$prey_reass[i] <- sample(samp_bag_medium, size = 1)
      } else if(gutcontent$prey_length[i]>600 & gutcontent$prey_length[i] <= 1500 & !length(samp_bag_medium)){
        gutcontent$prey_reass[i] <- gutcontent$prey_reass[i] 
      } else if(gutcontent$prey_length[i] > 1500 & !!length(samp_bag_big)){
        gutcontent$prey_reass[i] <- sample(samp_bag_big, size = 1)
      } else if(gutcontent$prey_length[i] > 1500 & !length(samp_bag_big)){
        gutcontent$prey_reass[i] <- gutcontent$prey_reass[i]
      } else {
        gutcontent$prey_reass[i] <- sample(samp_bag_all, size = 1)
      }
    } else {
      gutcontent$prey_reass[i] <- gutcontent$prey_reass[i]
    }
    i = i+1
  }
  j = j+1
}
table(gutcontent$prey_reass)[c("unknown n", "unknown c")]
gutcontent$NASC_zoo <- ave(gutcontent$NASC_zoo,gutcontent$region,FUN=function(x) 
  ifelse(is.na(x), mean(x,na.rm=TRUE), x))
gutcontent$surf_sal_kgm3 <- ave(gutcontent$surf_sal_kgm3,gutcontent$region,FUN=function(x) 
  ifelse(is.na(x), mean(x,na.rm=TRUE), x))
gutcontent$surf_temp_degC <- ave(gutcontent$surf_temp_degC,gutcontent$region,FUN=function(x) 
  ifelse(is.na(x), mean(x,na.rm=TRUE), x))
gutcontent$prof_mel <- ave(gutcontent$prof_mel,gutcontent$region,FUN=function(x) 
  ifelse(is.na(x), mean(x,na.rm=TRUE), x))
write.csv(gutcontent, "/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/gutcontent_bosa_20210107.csv")
```


# Carbon content calculations based on formulas
```{r carbon}
gutcontent <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/gutcontent_bosa_20210107.csv")
eggSACK <- function(x){
  x$num_eggs_in_egg_sack <- NA
  x$diam_eggs_in_egg_sack <- NA
  for (i in 1:dim(x)[1]){
    if(x$prey_id[i] == "egg sack"){
      char <- as.character(x$comments_on_gut_content[i])
      char_sub <- substr(char, start = 1, stop = nchar(char)-2)
      splitting <- strsplit(char_sub, split = "x")
      x$num_eggs_in_egg_sack[i] <- as.numeric(splitting[[1]][1])
      x$diam_eggs_in_egg_sack[i] <- as.numeric(splitting[[1]][2])
    }
    i = i+1
  }
  return(x)
}
#....calculate carbon content----
gutcontent <- eggSACK(gutcontent)
gutcontent$carbon_ug <- with(gutcontent,
                             ifelse(prey_reass %in% c("pseudocalanus sp/metridia longa n", "pseudocalanus sp", "pseudocalanus sp n", "unknown nc", "unknown n", "calanoid sp n", "microcalanus sp n", "microcalanus sp  n"), 0.447*(10^(2.515*log10(prey_length/1000)+0.975)),
                                    ifelse(prey_reass == "egg", 0.14*10^-6*(4/3*pi*(prey_length/2)^3), 
                                           ifelse(prey_reass %in% c("calanus sp n", "calanus glacialis n"), 4.29*10^-6*prey_length^2.05,
                                                  ifelse(prey_reass %in% c("unknown c", "calanoid sp c", "calanoid sp", "microcalanus sp c", "calanus finmarchicus c", "chiridus sp c", "heterorhabdus norvegicus c", "paraheterorhabdus compactus c", "spinocalanus sp c","scolecithricella sp c"), 10^(3.07*log10(prey_length)-8.37),
                                                         ifelse(prey_reass %in% c("pseudocalanus sp c", "pseudocalanus sp/acartia sp c"), 0.447*10^(2.85*log10(prey_length)-7.62),
                                                                ifelse(prey_reass %in% c("oithona similis c", "oithona similis", "triconia borealis c", "oncea sp c", "onceaidae sp c", "onceaidae sp", "cyclopoid sp c"), 9.4676*10^-7*prey_length^2.16,
                                                                       ifelse(prey_reass %in% c("calanus glacialis c", "calanus sp c"), 4.742*(prey_length/1000)^3.452,
                                                                              ifelse(prey_reass %in% c("bivalve larvae", "cirripedia sp n", "cirripedia sp"), 3.06*10^-8*prey_length^2.88,
                                                                                     ifelse(prey_reass %in% c("metridia longa n", "acartia sp n"), 3.18*10^-9*prey_length^3.31,
                                                                                            ifelse(prey_reass == "metridia longa c", 7.498*(prey_length/1000)^3.225,
                                                                                                   ifelse(prey_reass == "limacina helicina", 10^(3.102*log10(prey_length/1000)+1.469),
                                                                                                          ifelse(prey_reass == "appendicularian sp" | prey_reass == "oikopleura sp", 8.2*10^-8*prey_length^2.70,
                                                                                                                 ifelse(prey_reass == "coscinodiscus sp", 10^(-0.541+0.811*log10(((prey_length/2)^3*4*pi)/3))*10^-6,
                                                                                                                        ifelse(prey_reass == "fritillaria sp", 10^-9.45*prey_length^3.241,
                                                                                                                               ifelse(prey_reass == "acartia sp c", 1.023*10^-8*prey_length^2.906,
                                                                                                                                      ifelse(prey_reass == "eurytemora sp c", 0.447*(10^(2.96*log10(prey_length)-7.604)),
                                                                                                                                             ifelse(prey_reass == "podon sp" | prey_reass == "podon sp n",10^(4.15*log10(prey_length)-11.15)*10^-3,
                                                                                                                                                    ifelse(prey_reass == "calanus hyperboreus c", 7.263*(prey_length/1000)^3.106,
                                                                                                                                                           ifelse(prey_reass %in% c("digested matter", "unknown","vertebrae"), 0.4*109.08*(pi*((prey_height/1000)/2)^2*(prey_length/1000))^0.9591, 
                                                                                                                                                                  ifelse(prey_reass %in% c("oithona similis n", "cyclopoid sp n"), 5.545*10^-8*prey_length^2.71,
                                                                                                                                                                         ifelse(prey_reass == "chaetognath sp", 10^(3.16*log10(prey_length/1000)-1.29),
                                                                                                                                                                                ifelse(prey_reass == "boroecia maxima", 0.346*exp(3.8686*(prey_length/1000))*0.4,
                                                                                                                                                                                       ifelse(prey_reass == "harpacticoid sp c", exp(1.03*log(prey_length)-7.07),
                                                                                                                                                                                              ifelse(prey_reass == "paraeuchaeta sp c", 0.447*1000*(0.0075*(prey_length/1000)^3.274+ (0.07*0.0075*(prey_length/1000)^3.274)),
                                                                                                                                                                                                     ifelse(prey_reass %in% c("polychaetae larvae", "vers"), 1.42*10^-4*prey_length^1.47, 
                                                                                                                                                                                                            ifelse(prey_reass %in% c("decapoda sp", "decapoda sp meta", "crustacea sp meta"), 0.4*10^(1.08*prey_length/1000-0.89), 
                                                                                                                                                                                                                   ifelse(prey_reass == "egg sack", num_eggs_in_egg_sack*0.14*10^-6*(4/3*pi*(diam_eggs_in_egg_sack/2)^3),
                                                                                                                                                                                                                          ifelse(prey_reass == "amphipod sp", (log10(prey_length/1000)-0.063)/0.277,
                                                                                                                                                                                                                                 NA)))))))))))))))))))))))))))))

gutcontent$carbon_mg <- gutcontent$carbon_ug/1000

#write.csv(gutcontent, "/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/gutcontent_bosa_carbon20210121.csv")
```


# Prepare fish dataset
```{r gutcontent to fish}
gutcontent2 <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/gutcontent_bosa_carbon20210121.csv")%>% select(-X)
gutcontent2$prey_id_comb <- with(gutcontent2, ifelse( prey_reass %in% c("triconia borealis c", "oithona similis c", "onceaidae sp c", "oncea sp c", "cyclopoid sp c"), "cyclopoidae sp c", 
                                                      ifelse( prey_reass %in% c("appendicularian sp", "fritillaria sp", "oikopleura sp"), "appendicularia", 
                                                              ifelse( prey_reass %in% c("calanus sp n", "calanus glacialis n"), "calanus sp n",
                                                                      ifelse(prey_reass %in% c("calanoid sp", "calanoid sp c", "heterorhabdus norvegicus c", "metridia longa c", "chiridus sp c", "acartia sp c", "eurytemora sp c", "pseudocalanus sp/acartia sp c", "paraheterorhabdus compactus c", "paraeuchaeta sp c", "scolecithricella sp c", "spinocalanus sp c", "microcalanus sp c"), "calanoid sp c", 
                                                                             ifelse(prey_reass %in% c("calanoid sp n", "acartia sp n", "pseudocalanus sp/metridia longa n", "metridia longa n", "cyclopoid n", "microcalanus sp n", "microcalanus sp  n", "oithona similis n", "cyclopoid sp n", "unknown n"), "other copepodite n", 
                                                                                    ifelse(prey_reass %in% c("egg","egg sack"), "egg",
                                                                                           ifelse(prey_reass %in% c("fecal pellet","radiolarian sp","vers", "unknown", "chaetognath sp", "vertebrae", "trematoda sp", "parasite","polychaetae larvae", "digested matter", "crustacea sp meta", "amphipod sp", "decapoda sp meta", "euphausiacea sp", "decapoda sp", "boroecia maxima", "cirripedia sp", "cirripedia sp n", "podon sp", "coscinodiscus sp"), "other",
                                                                                                  ifelse(prey_reass %in% c("unknown c", "harpacticoid sp c", "unknown nc"),"other copepodite sp",
                                                                                                         ifelse(prey_reass %in% c("calanus sp c", "calanus finmarchicus c"), "calanus sp c", 
                                                                                                                as.character(prey_reass)))))))))))
unique(gutcontent2$prey_id_comb)

fs.fish.data <- aggregate(carbon_mg ~ unique_fish_id + est_standard_length + est_height_anus + region + year + station + sampling_date + bu_date + open_water_day + NASC_zoo + surf_sal_kgm3 + surf_temp_degC + prof_mel + indstandard, data = gutcontent2, FUN = sum, na.action = na.omit)

fs.fish.data$fish_WW <- (0.0055*((fs.fish.data$est_standard_length/10)^3.19))*1000 
fs.fish.data$feeding_success <- fs.fish.data$carbon_mg/fs.fish.data$fish_WW

prey_range <- aggregate(prey_length ~ unique_fish_id, data = gutcontent2, FUN = function(x, na.rm = TRUE) {max(x) - min(x)})
prey_min <- aggregate(prey_length ~ unique_fish_id, data = gutcontent2, FUN=min, na.rm = TRUE)
prey_max <- aggregate(prey_length ~ unique_fish_id, data = gutcontent2, FUN=max, na.rm = TRUE)
prey_median <- aggregate(prey_length ~ unique_fish_id, data = gutcontent2, FUN=median, na.rm = TRUE) 
fs.fish.data$prey_range_um <- prey_range$prey_length
fs.fish.data$prey_min_um <- prey_min$prey_length
fs.fish.data$prey_max_um <- prey_max$prey_length
fs.fish.data$prey_median_um <- prey_median$prey_length

plot(est_height_anus ~ est_standard_length, data = fs.fish.data)
lm.HASL <- lm(est_height_anus ~ est_standard_length, data = fs.fish.data)
summary(lm.HASL)
plot(lm.HASL)
fs.fish.data$fish_cond <- residuals(lm.HASL)

prey_matrix <- data.table::dcast(data.table::setDT(gutcontent2), unique_fish_id~prey_reass, length)
fish.data.prey <- merge(fs.fish.data, prey_matrix)

prey_matrix_comb <- data.table::dcast(data.table::setDT(gutcontent2), unique_fish_id~prey_id_comb, length)
fish.data.prey.comb <- merge(fs.fish.data, prey_matrix_comb)

#write.csv(fish.data.prey, "/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/fish_data_PC_20210107.csv")
#write.csv(fish.data.prey.comb, "/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/fish_data_comb_PC_20210107.csv")

```

# dfish et dpreys
```{r look at prey matrix}
dfish <-read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/fish_data_PC_20210107.csv", check.names = FALSE) %>% select(-1)
str(dfish)

dpreys_comb <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/fish_data_comb_PC_20210107.csv", check.names = FALSE) %>% select(-1)
str(dpreys_comb)

gutcontent2 <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/gutcontent_bosa_carbon20210121.csv")%>% select(-X)
gutcontent2$prey_id_comb <- with(gutcontent2, ifelse( prey_reass %in% c("triconia borealis c", "oithona similis c", "onceaidae sp c", "oncea sp c", "cyclopoid sp c"), "cyclopoidae sp c", 
                                                      ifelse( prey_reass %in% c("appendicularian sp", "fritillaria sp", "oikopleura sp"), "appendicularia", 
                                                              ifelse( prey_reass %in% c("calanus sp n", "calanus glacialis n"), "calanus sp n",
                                                                      ifelse(prey_reass %in% c("calanoid sp", "calanoid sp c", "heterorhabdus norvegicus c", "metridia longa c", "chiridus sp c", "acartia sp c", "eurytemora sp c", "pseudocalanus sp/acartia sp c", "paraheterorhabdus compactus c", "paraeuchaeta sp c", "scolecithricella sp c", "spinocalanus sp c", "microcalanus sp c"), "calanoid sp c", 
                                                                             ifelse(prey_reass %in% c("calanoid sp n", "acartia sp n", "pseudocalanus sp/metridia longa n", "metridia longa n", "cyclopoid n", "microcalanus sp n", "microcalanus sp  n", "oithona similis n", "cyclopoid sp n", "unknown n"), "other copepodite n", 
                                                                                    ifelse(prey_reass %in% c("egg","egg sack"), "egg",
                                                                                           ifelse(prey_reass %in% c("fecal pellet","radiolarian sp","vers", "unknown", "chaetognath sp", "vertebrae", "trematoda sp", "parasite","polychaetae larvae", "digested matter", "crustacea sp meta", "amphipod sp", "decapoda sp meta", "euphausiacea sp", "decapoda sp", "boroecia maxima", "cirripedia sp", "cirripedia sp n", "podon sp", "coscinodiscus sp"), "other",
                                                                                                  ifelse(prey_reass %in% c("unknown c", "harpacticoid sp c", "unknown nc"),"other copepodite sp",
                                                                                                         ifelse(prey_reass %in% c("calanus sp c", "calanus finmarchicus c"), "calanus sp c", 
                                                                                                                as.character(prey_reass)))))))))))

```

# Question 1
```{r explo Question 1 variation rÃ©gions}
#Beaufort Sea: Mackenzie Shelf, Amundsen Gulf Maud
#Kitikmeot: Coronation Maud, Larsen Sound, Peel Sound
#Baffin Bay: North Water, Lancaster Sound, NW Baffin Bay
plot(surf_temp_degC ~ region, data = dfish)
lattice::xyplot(surf_temp_degC ~ as.factor(year)|region, data = dfish)
plot(open_water_day ~ region, data = dfish)
lattice::xyplot(open_water_day ~ as.factor(year)|region, data = dfish)

lattice::bwplot(feeding_success ~ as.factor(year)|region, data = dfish)
lattice::bwplot(log10(feeding_success) ~ as.factor(year)|region, data = dfish)
aov.env <- aov(surf_temp_degC ~ region + year, data = dfish)
summary(aov.env)
TukeyHSD(aov.env, which = "region")
```
# Question 2
```{r explo Question 2 poissons}
#taille et dÃ©bÃ¢cle
cor(dfish$est_standard_length, dfish$open_water_day)
plot(dfish$est_standard_length~dfish$open_water_day) #lÃ©gÃ¨re augmentation, mais c'est variable
#taille et carbone
plot(dfish$carbon_mg ~ dfish$fish_WW)
plot(dfish$carbon_mg ~ dfish$est_standard_length)
plot(log10(dfish$carbon_mg) ~ dfish$fish_WW)
plot(log10(dfish$carbon_mg) ~ dfish$est_standard_length)

plot(log10(feeding_success)~est_standard_length, data = dfish)
plot(log10(feeding_success) ~ fish_WW, data = dfish) #mÃªme relation que avec le carbone, mais c'est un peu contre intuitif de vÃ©rifier la relation mÃªme corrigÃ©e, tk
plot(log10(feeding_success) ~ fish_WW, data= dfish[dfish$est_standard_length>=25,]) #lÃ©gÃ¨re augmentation pour juvÃ©niles en fonction de la condition, mais peu importe la condition chez les larves, le succÃ¨s alimentaire reste assez variable (les rÃ©sidus sont aussi moins dispersÃ©s)
plot(log10(feeding_success) ~ fish_WW, data= dfish[dfish$est_standard_length<25,])

plot(log10(feeding_success) ~ fish_cond, data = dfish) #aucune relation, intÃ©ressant -> demander Ã  Caroline si c'est bien les rÃ©sidus de la rÃ©gression HA ~ SL
plot(log10(feeding_success) ~ fish_cond, data= dfish[dfish$est_standard_length>=25,])
plot(log10(feeding_success) ~ fish_cond, data= dfish[dfish$est_standard_length<25,]) #Ã©parpillement quand les poissons atteignent 30mm
plot(fish_cond~feeding_success, data = dfish)
plot(fish_cond~log10(feeding_success), data = dfish)
#pas vraiment de relation -> rÃ©sidus pas assez dispersÃ©s (on n'a pas vraiment de valeurs extrÃªmes)

dfish$size_catego <- with(dfish, ifelse(est_standard_length<10, "<10", 
                                        ifelse(est_standard_length >=10 & est_standard_length<15, "10-15",
                                               ifelse(est_standard_length>=15 & est_standard_length<20, "15-20",
                                                      ifelse(est_standard_length>=20 & est_standard_length<25, "20-25",
                                                             ">25")))))
dfish$logFS <- log10(dfish$feeding_success)
bwplot(logFS ~ fish_cond|size_catego, data = dfish)

#FS et environnement
plot(logFS ~ NASC_zoo, data = dfish) #trÃ¨s lÃ©gÃ¨re augmentation mais rien de signifcatif
plot(logFS ~ surf_temp_degC, data = dfish) #lÃ©gÃ¨re augmentation
plot(logFS ~ surf_sal_kgm3, data = dfish) #pas grand chose
plot(logFS ~ open_water_day, data = dfish) #augmentation loglinÃ©aire

dfish %>% select(logFS, open_water_day, surf_sal_kgm3, surf_temp_degC, NASC_zoo, fish_cond) %>% plot
#corrÃ©lation visible entre dÃ©bÃ¢cle & tempÃ©rature, dÃ©bÃ¢cle et NASC_zoo et lÃ©gÃ¨re corrÃ©lation entre NASC_zoo et tempÃ©rature
boxplot(logFS ~ region,data = dfish)

dfish$province <- with(dfish, ifelse(region %in% c("Mackenzie Shelf", "Amundsen Gulf Mouth"), "Beaufort Sea",
                                     ifelse(region %in% c("Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound"), "Kitikmeot",
                                            ifelse(region == "NEG", "Greenland Sea",
                                                   "NW Baffin Bay"))))

boxplot(logFS ~ province, data = dfish)
```
# Question 3 part 1
```{r explo Question 3 proies}
plot(prey_range_um/1000 ~ est_standard_length, data = dfish) # les grosses larves mangent Ã  la fois de grosses et petites choses
plot(prey_min_um/1000 ~ est_standard_length, data = dfish)
plot(prey_max_um/1000 ~ est_standard_length, data = dfish)
plot(prey_median_um/1000 ~ est_standard_length, data = dfish) #vraiment rare que les larves, peu importe la taille, mangent de grosses affaires
plot(log10(feeding_success) ~ prey_median_um, data = dfish)
median(dfish[which(dfish$feeding_success > 0.001),"prey_median_um"])
plot(log10(feeding_success) ~ prey_max_um, data = dfish)
plot(log10(feeding_success) ~ prey_min_um, data = dfish)
plot(log10(feeding_success) ~ prey_range_um, data = dfish)
plot((feeding_success) ~ prey_max_um, data = dfish)
plot((feeding_success) ~ prey_min_um, data = dfish)
plot((feeding_success) ~ prey_range_um, data = dfish)

#pas vraiment de relation entre taille des proies et FS

dfish$total_preys <- rowSums(dfish[,c(20:84)])
plot(total_preys ~ prey_max_um, data = dfish)
plot(total_preys ~ prey_min_um, data = dfish)
plot(total_preys~prey_range_um, data = dfish)

```
# Question 3 part 2
```{r prey occurence}
freqtable <- as.data.frame(table(gutcontent2$prey_id_comb,gutcontent2$region))
freqtable$Var2 <- ordered(freqtable$Var2, c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "NEG"))
color = grDevices::colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]
colours_bar <- sample(color, size =15)
ggplot() +
  geom_bar(data =freqtable, mapping = aes(fill=Var1, y=Freq, x=Var2), position="fill", stat="identity") +
  scale_fill_manual(values =colours_bar)

freqtable2 <- as.data.frame(table(gutcontent2$prey_id_comb,gutcontent2$station))
ggplot() +
  geom_bar(data =freqtable2, mapping = aes(fill=Var1, y=Freq, x=Var2), position="fill", stat="identity") +
  scale_fill_manual(values =colours_bar)

carbon_input <- aggregate(carbon_mg ~ prey_id_comb + region, data = gutcontent2, FUN = sum)
ggplot() +
  geom_bar(data =carbon_input, mapping = aes(fill=prey_id_comb, y=carbon_mg, x=region), position="fill", stat="identity") +
  scale_fill_manual(values =colours_bar) + 
  labs(x = "", y = "")

carbon_input2 <- aggregate(carbon_mg ~ prey_id_comb + station, data = gutcontent2, FUN = sum)
ggplot() +
  geom_bar(data =carbon_input2, mapping = aes(fill=prey_id_comb, y=carbon_mg, x=station), position="fill", stat="identity") +
  scale_fill_manual(values =colours_bar) 

#en gros, bouffer des calanus = payant Ã  souhait

```



# PCA
```{r PCA and plot}
fish_pca <-  dpreys_comb %>% select(-unique_fish_id,-fish_WW, -est_height_anus,-carbon_mg, -surf_sal_kgm3, -station, -sampling_date, -year, -bu_date, -c( 17:18, 20:42)) %>%PCA(quali.sup = c(2), quanti.sup = c(7))

dpreys_comb$pc1 <- fish_pca$ind$coord[, 1]
dpreys_comb$pc2 <- fish_pca$ind$coord[, 2]

pca.vars <- fish_pca$var$coord %>% data.frame
pca.vars$vars <- rownames(pca.vars)
pca.vars.m <- reshape2::melt(pca.vars, id.vars = "vars")
pca.var.sup <- fish_pca$quanti.sup$coord %>% data.frame

colours <- c("#6BCA54", "#FF5733", "#73C6B6", "#5E82D6", "#424949", "#A93226", "#C39BD3", "#FFC300", "#BDC3C7")
posArrowsX <- c(4, 4, 4, 3.25,4,4)
posArrowsY<- c(4.25, 3.5, 4.75, 4.25,4,4)
p_transf <- ggplot() +  
  geom_jitter(data = dpreys_comb, aes(x = pc1, y = pc2, colour = region), size = 2.5)+
  coord_equal()+
  theme_classic()+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.position = c(0.25,0.19), 
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size = 20), 
        legend.text = element_text(size = 22), 
        axis.title = element_text(size = 25), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill=alpha('white', 0.4)))+
  labs(x= paste("PC1 (", round(fish_pca$eig["comp 1", "percentage of variance"], digits = 2), "%)"),
       y= paste("PC2 (", round(fish_pca$eig["comp 2", "percentage of variance"], digits = 2), "%)")) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_point(size = 2) +
  geom_segment(data = pca.vars, aes(x = 0, xend = Dim.1*4, y = 0, yend = Dim.2*4),
               arrow = arrow(length = unit(0.025, "npc"), type = "open"), 
               lwd = 0.5) + 
  geom_text(data = pca.vars, 
            aes(x = Dim.1*posArrowsX, y =  Dim.2*posArrowsY,
                label = c("LS","Jours depuis\ndÃ©bÃ¢cle","Abondance du\nzooplankton", "TempÃ©rature de\nsurface","CompÃ©", "Condition physique")), 
            check_overlap = FALSE, size = 8.5)+ 
  scale_color_manual(values = colours, name = "Region") +
  geom_segment(data = pca.var.sup, aes(x = 0, xend = Dim.1*5, y = 0, yend = Dim.2*5),
               arrow = arrow(length = unit(0.025, "npc"), type = "open"),
               lwd = 0.5, lty = "dotted") + 
  geom_text(data = pca.var.sup, 
            aes(x = Dim.1*4, y =  Dim.2*4,
                label = "SuccÃ¨s\nalimentaire"), size = 8.5, col = '#868B8D')
p_transf
ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/PCA_fish.png", plot = p_transf, dpi = 500, width = 14, height = 10, bg = "transparent")
```
# CA
```{r CA, PCA, RDA}
CA.preys <- dpreys_comb %>% select(22:42) %>% CA()
summary(CA.preys) #first two axes explains 24%, not really good
plot(CA.preys)

# PCA.prey <- dpreys_comb %>% select(-unique_fish_id, -est_height_anus, -fish_WW, -carbon_mg) %>% PCA(quanti.sup = c(7), quali.sup = c(2))

env <- dpreys_comb %>% select(-region, -unique_fish_id, -est_height_anus, -fish_WW, -carbon_mg, -surf_sal_kgm3, -est_standard_length, -c(13:34))
preys <- dpreys_comb %>% select(13:34) %>% decostand(method = "hellinger")
rda.preys <- rda(X = preys, Y = env, scale = TRUE)
plot(rda.preys)
summary(rda.preys) #not really good, two first axes explain only 11%...

preys_pres_abs <-dpreys_comb %>% select(13:34) %>% sapply(FUN = function(x) 
  ifelse(x > 0, 1, 0))
rda.preys.presabs <- rda(X = preys_pres_abs, Y = env, scale = TRUE)
plot(rda.preys.presabs)
summary(rda.preys.presabs)

PCA.prey <- dpreys_comb %>% select(-unique_fish_id, -est_height_anus, -fish_WW, -carbon_mg, -est_standard_length) %>% PCA(quanti.sup = c(6), quali.sup = c(1))
```


# Bray Curtis, MarineCusa, and others.......
wo data sets were generated for the multivariate analysis: Dataset A, where the gravimetric
contribution of BDC in percent (%W) was calculated for each stomach by dividing prey taxa weight
by total prey weight for each stomach and multiplying the result by 100; 

and dataset B, in which the average BDC weight was calculated for each trawl by adding total prey taxa weight for each trawl, dividing total prey taxa weight by total prey weight for each trawl, and multiplying the result by 100. Dataset B calculation were performed separately for each polar cod size category
```{r BC}
tot_carbon <- aggregate(carbon_mg ~ unique_fish_id, data = gutcontent2, FUN = sum)
colnames(tot_carbon) <- c("unique_fish_id", "sum_carbon")

A <- gutcontent2 %>% merge(tot_carbon) %>% 
  mutate(BDC_perc = carbon_mg/sum_carbon*100)

df_A <- aggregate(BDC_perc ~ unique_fish_id + region + prey_id_comb + station + year, data= A, FUN = sum)

tot_carbon2 <- aggregate(carbon_mg ~ station + year, data = gutcontent2, FUN = sum)
colnames(tot_carbon2) <- c("station","year", "sum_carbon2")
B <-  gutcontent2%>% merge(tot_carbon2) %>%
  mutate(BDC_perc_station = carbon_mg/sum_carbon2*100)
df_B <- aggregate(BDC_perc_station ~ region + prey_id_comb + station + year, data=B, FUN = sum)

```
# SÃ©lection de modÃ¨les

```{r mixed linear model}
#vÃ©rification ajustement des modÃ¨les lm----
lm.fs.untranf <- lm(feeding_success ~ open_water_day + fish_cond, data = dfish, na.action = na.omit)
plot(lm.fs.untranf)

lm.glob1 <- lm(log10(feeding_success) ~ open_water_day + fish_cond, data = dfish, na.action = na.omit)
summary(lm.glob1)

#pdf("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/glob1_res.pdf")
plot(rstudent(lm.glob1) ~ fitted(lm.glob1), ylab = "RÃ©sidus de Student", xlab = "Valeurs prÃ©dites")
#dev.off()

plot(hatvalues(lm.glob1), 
     ylab = "Hat values",
     xlab = "Observations", main = "Effet de levier")
abline(h = 2*3/324, lty = 2) #on a un effet de levier pour certaines valeurs, mais je ne crois pas qu'il soit trop

# pdf("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/glob1_cook.pdf")
plot(cooks.distance(lm.glob1),
     ylab = "Distance de Cook", 
     xlab = "Observations", 
     main = "Influence des observations")
abline(h = 3/(324-4), lty = 2) #rien en haut de 1, mais un bon nombre sont en haut du seuil
# dev.off()

lm.glob2 <- lm(log10(feeding_success) ~ surf_temp_degC + NASC_zoo + fish_cond, data = dfish, na.action = na.omit)
summary(lm.glob2)

# pdf("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/glob2_res.pdf")
plot(rstudent(lm.glob2) ~ fitted(lm.glob2), ylab = "RÃ©sidus de Student", xlab = "Valeurs prÃ©dites")
# dev.off()

plot(hatvalues(lm.glob2), ylab = "Hat values",
     xlab = "Observations", main = "Effet de levier")
abline(h = 2*4/324, lty = 2) #on a un effet de levier pour certaines valeurs, mais je ne crois pas qu'il soit trop

# pdf("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/glob2_cook.pdf")
plot(cooks.distance(lm.glob2), ylab = "Distance de Cook", xlab = "Observations", main = "Influence des observations")
abline(h = 4/(324-4), lty = 2) #rien en haut de 1, mais un bon nombre sont en haut du seuil
dev.off()
#modÃ¨les mixtes----
lme.null <- lme(log10(feeding_success) ~1, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.null)

lme.glob1 <- lme(log10(feeding_success) ~ surf_temp_degC + NASC_zoo + fish_cond + indstandard, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.glob1) #serait mieux d'utiliser une transformation log10

lme.glob2 <- lme(log10(feeding_success) ~ open_water_day + fish_cond, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.glob2)
performance::r2(lme.glob2)

lme.bu <- lme(log10(feeding_success) ~ open_water_day, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.bu)

lme.cond <- lme(log10(feeding_success) ~ fish_cond, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.cond)

lme.comp <- lme(log10(feeding_success) ~ indstandard, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.comp)

lme.NASC <- lme(log10(feeding_success) ~ NASC_zoo, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.NASC)

lme.temp <- lme(log10(feeding_success) ~ surf_temp_degC, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.temp)

list.models <- list(null = lme.null, tempNASCFishcond = lme.glob1, buFishcond= lme.glob2, buOnly = lme.bu, tempONLY = lme.temp, condOnly = lme.cond, NASConly = lme.NASC, compONLY = lme.comp)

selection <- AICcmodavg::aictab(list.models)
selection #les deux premiers modÃ¨les semblent Ãªtre ceux qui ont le plus de poids

est.bu <- AICcmodavg::modavg(list.models, "open_water_day")
est.bu
est.fish.cond <- AICcmodavg::modavg(list.models, "fish_cond")
est.fish.cond
est.temp <- AICcmodavg::modavgShrink(list.models, "surf_temp_degC")
est.temp
est.zoo <- AICcmodavg::modavgShrink(list.models, "NASC_zoo")
est.zoo

new.data <- data.frame(
  open_water_day = seq(from = min(dfish$open_water_day), to = max(dfish$open_water_day), length.out = 100),
  fish_cond = mean(dfish$fish_cond),
  region = "Amundsen Gulf Mouth",
  surf_temp_degC = mean(dfish$surf_temp_degC),
  NASC_zoo = mean(dfish$NASC_zoo),
  indstandard = mean(dfish$indstandard)
)
preds <- AICcmodavg::modavgPred(cand.set = list.models, newdata = new.data)
preds2 <- predict(lme.glob2, newdata =new.data)

new.data$fit <- preds$mod.avg.pred
new.data$se <- preds$uncond.se
new.data$low95 <- preds$lower.CL
new.data$supp95 <- preds$upper.CL

#pdf("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/preds_bu.pdf")
plot(smooth(fit) ~ open_water_day, data = new.data,
     ylab = "log10(SuccÃ¨s alimentaire des jeunes morues polaires)",
     xlab = "Nombre de jours juliens depuis la dÃ©bÃ¢cle",
     main = "Valeurs prÃ©dites pondÃ©rÃ©es de succÃ¨s alimentaire (+- IC 95%)",
     type = 'l')
lines(x = new.data$open_water_day, y = smooth(new.data$supp95), lty = 'dotted')
lines(x = new.data$open_water_day, y = smooth(new.data$low95), lty = 'dotted')
#dev.off()
```


# Poster RSA QO

```{r RSA FS OWD }
mean_logFS <- aggregate(logFS~ region + open_water_day, data = dfish, FUN = mean)
mean_logFS$region <- ordered(mean_logFS$region, c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "NEG"))

colours <- pals::stepped(n = 24)[c(1,4,9,11,12,13, 15,16,17)]
FS_OWD <- ggplot() +
  geom_point(data = mean_logFS, mapping = aes(x = open_water_day, y = logFS, color = region), size = 10)+
  geom_line(data = new.data, mapping = aes(y = fit, x = open_water_day)) + 
  geom_ribbon(data = new.data, aes(x = open_water_day, y = NULL, ymin = low95, ymax = supp95),
              alpha = .15) + 
  theme_classic()+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.position = c(0.25,0.78), 
        axis.text.x = element_text(size=30),
        axis.text.y = element_text(size = 30), 
        legend.text = element_text(size = 22), 
        axis.title = element_text(size = 30), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill="transparent")) + 
  labs(x = "Nombre de jours depuis la dÃ©bÃ¢cle", y = "log10(SuccÃ¨s alimentaire moyen)") + 
  scale_color_manual(values = colours, name = "RÃ©gion", labels = c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "North-Eastern\nGreenland Sea")) + 
  scale_x_continuous(breaks = c(-20, 0, 20, 40, 60, 80, 100))

FS_OWD
ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/FS_OWD_fish.png", plot = FS_OWD, dpi = 500, width = 14, height = 10, bg = "transparent")




```


```{r RSA distribution proies}

library(pals)
colours_bar <- pals::stepped(n = 24)[c(20:17, 16:13, 12,5,8,4:1)]

gutcontent2$OWD_cat <- with(gutcontent2, ifelse(open_water_day <= 0, "before_bu",
                                                ifelse(open_water_day >0 & open_water_day <20, "0-20",
                                                       ifelse(open_water_day >=20 & open_water_day<40, "20-40",
                                                              ifelse(open_water_day >=40 & open_water_day <60, "40-60",
                                                                     ifelse(open_water_day >=60 & open_water_day < 80, "60-80", "80+"))))))

freqtable <- as.data.frame(table(gutcontent2$prey_id_comb,gutcontent2$region))
freqtable$Var2 <- ordered(freqtable$Var2, c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "NEG"))
freqtable$Var1 <- ordered(freqtable$Var1, c("appendicularia", "bivalve larvae", "egg", "limacina helicina", "calanoid sp c", "cyclopoidae sp c",  "other copepodite sp", "other copepodite n", "other", "pseudocalanus sp c", "pseudocalanus sp n", "calanus glacialis c", "calanus hyperboreus c", "calanus sp c", "calanus sp n"))


preys_occ <- ggplot() +
  geom_bar(data =freqtable, mapping = aes(fill=Var1, y=Freq, x=Var2), position="fill", stat="identity") +
  ggtitle( "FrÃ©quence d'occurence\ndans la diÃ¨te")+
  scale_fill_manual(name = "", values =colours_bar, labels = c("Appendicularia", 
                                                               "Bivalvia", 
                                                               "Oeuf", 
                                                               "Gastropoda", 
                                                               "Calanoidae spp.", 
                                                               "Cyclopoidae spp.", 
                                                               "Autre copÃ©podite", 
                                                               "Autre nauplii",
                                                               "Autre type de proies",
                                                               expression(paste(italic("Pseudocalanus "), "spp.", sep = "")),
                                                               expression(paste(italic("Pseudocalanus "), "spp.  Nauplii", sep = "")),
                                                               expression(italic("Calanus glacialis")), 
                                                               expression(italic("Calanus hyperboreus")), 
                                                               expression(paste(italic("Calanus "), "spp.", sep = "")), 
                                                               expression(paste(italic("Calanus "), "spp.  Nauplii", sep = ""))
  ))+ 
  theme_classic() +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size = 20), 
        legend.text = element_text(size = 22),
        legend.text.align = 0,
        axis.title = element_text(size = 25), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        plot.title = element_text(size = 30, hjust = 0.5)) + 
  labs(y = "Proportion", x = "") + 
  scale_x_discrete(labels = c("MS", "AGM", "CM", "LV", "PS", "LS", "NW", "WBB", "NEG"))
preys_occ
#ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/preys_occ.png", plot = preys_occ, dpi = 500, width = 14, height = 10, bg = "transparent")

carbon_input <- aggregate(carbon_mg ~ prey_id_comb + region, data = gutcontent2, FUN = sum)
carbon_input$region <- ordered(carbon_input$region, c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "NEG"))
carbon_input$prey_id_comb <- ordered(carbon_input$prey_id_comb, c("appendicularia", "bivalve larvae", "egg", "limacina helicina", "calanoid sp c", "cyclopoidae sp c",  "other copepodite sp", "other copepodite n", "other", "pseudocalanus sp c", "pseudocalanus sp n", "calanus glacialis c", "calanus hyperboreus c", "calanus sp c", "calanus sp n"))
preys_carbon <- ggplot() +
  geom_bar(data =carbon_input, mapping = aes(fill=prey_id_comb, y=carbon_mg, x=region), position="fill", stat="identity") +
  ggtitle("Proportion en carbone\ndans la diÃ¨te")+
  scale_fill_manual(name = "", values =colours_bar, labels = c("Appendicularia", 
                                                               "Bivalvia", 
                                                               "Oeuf", 
                                                               "Gastropoda", 
                                                               "Calanoidae spp.", 
                                                               "Cyclopoidae spp.", 
                                                               "Autre copÃ©podite", 
                                                               "Autre nauplii",
                                                               "Autre type de proies",
                                                               expression(paste(italic("Pseudocalanus "), "spp.", sep = "")),
                                                               expression(paste(italic("Pseudocalanus "), "spp.  Nauplii", sep = "")),
                                                               expression(italic("Calanus glacialis")), 
                                                               expression(italic("Calanus hyperboreus")), 
                                                               expression(paste(italic("Calanus "), "spp.", sep = "")), 
                                                               expression(paste(italic("Calanus "), "spp.  Nauplii", sep = ""))
  )) + 
  theme_classic() +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size = 20), 
        legend.text = element_text(size = 22),
        legend.text.align = 0,
        axis.title = element_text(size = 25), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        plot.title = element_text(size = 30, hjust = 0.5)) + 
  labs(y = "", x = "RÃ©gion") + 
  scale_x_discrete(labels = c("MS", "AGM", "CM", "LV", "PS", "LS", "NW", "WBB", "NEG"))
preys_carbon

#ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/preys_carbon.png", plot = preys_carbon, dpi = 500, width = 14, height = 10, bg = "transparent")



freqtable3 <- as.data.frame(table(gutcontent2$prey_id_comb,gutcontent2$OWD_cat))
freqtable3$Var1 <- ordered(freqtable3$Var1, c("appendicularia", "bivalve larvae", "egg", "limacina helicina", "calanoid sp c", "cyclopoidae sp c",  "other copepodite sp", "other copepodite n", "other", "pseudocalanus sp c", "pseudocalanus sp n", "calanus glacialis c", "calanus hyperboreus c", "calanus sp c", "calanus sp n"))
freqtable3$Var2 <- ordered(freqtable3$Var2,c("before_bu", "0-20","20-40", "40-60", "60-80", "80+"))


preys_occ_owd <- ggplot() +
  geom_bar(data =freqtable3, mapping = aes(fill=Var1, y=Freq, x=Var2), position="fill", stat="identity") +
  ggtitle( "FrÃ©quence d'occurence\ndes proies dans la diÃ¨te")+
  scale_fill_manual(name = "", values =colours_bar, labels = c("Appendicularia", 
                                                               "Bivalvia", 
                                                               "Oeuf", 
                                                               "Gastropoda", 
                                                               "Calanoidae spp.", 
                                                               "Cyclopoidae spp.", 
                                                               "Autre copÃ©podite", 
                                                               "Autre nauplii",
                                                               "Autre type de proies",
                                                               expression(paste(italic("Pseudocalanus "), "spp.", sep = "")),
                                                               expression(paste(italic("Pseudocalanus "), "spp. Nauplii", sep = "")),
                                                               expression(italic("Calanus glacialis")), 
                                                               expression(italic("Calanus hyperboreus")), 
                                                               expression(paste(italic("Calanus "), "spp.", sep = "")), 
                                                               expression(paste(italic("Calanus "), "spp. Nauplii", sep = ""))
  ))+ 
  theme_classic() +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        axis.text.x = element_text(size=30),
        axis.text.y = element_text(size = 30), 
        legend.text = element_text(size = 22),
        legend.text.align = 0,
        axis.title = element_text(size = 35), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        plot.title = element_text(size = 35, hjust = 0.5)) + 
  labs(y = "Proportion", x = "Nombre de jours depuis la dÃ©bÃ¢cle")+
  scale_x_discrete(labels = c("Avant\ndÃ©bÃ¢cle", "0-20 j.", "20-40 j.", "40-60 j.", "60-80 j.", "80+ j."))
preys_occ_owd
ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/preys_OWD.png", plot = preys_occ_owd, dpi = 500, width = 17, height = 14, bg = "transparent")

carbon_input2 <- aggregate(carbon_mg ~ prey_id_comb + OWD_cat + unique_fish_id, data = gutcontent2, FUN = sum)
carbon_input3 <- aggregate(carbon_mg ~ prey_id_comb + OWD_cat, data = carbon_input2, FUN=mean)
carbon_input3$OWD_cat <- ordered(carbon_input3$OWD_cat ,c("before_bu", "0-20","20-40", "40-60", "60-80", "80+"))
carbon_input3$prey_id_comb <- ordered(carbon_input3$prey_id_comb, c("appendicularia", "bivalve larvae", "egg", "limacina helicina", "calanoid sp c", "cyclopoidae sp c",  "other copepodite sp", "other copepodite n", "other", "pseudocalanus sp c", "pseudocalanus sp n", "calanus glacialis c", "calanus hyperboreus c", "calanus sp c", "calanus sp n"))
preys_carbon_OWD <- ggplot() +
  geom_bar(data =carbon_input3, mapping = aes(y=carbon_mg, x=OWD_cat, fill = prey_id_comb), stat="identity") +
  ggtitle("Moyenne de carbone ingÃ©rÃ© par poisson\net contribution des proies")+
  scale_fill_manual(name = "", values =colours_bar, labels = c("Appendicularia", 
                                                               "Bivalvia", 
                                                               "Oeuf", 
                                                               "Gastropoda", 
                                                               "Calanoidae spp.", 
                                                               "Cyclopoidae spp.", 
                                                               "Autre copÃ©podite", 
                                                               "Autre nauplii",
                                                               "Autre type de proies",
                                                               expression(paste(italic("Pseudocalanus "), "spp.", sep = "")),
                                                               expression(paste(italic("Pseudocalanus "), "spp. Nauplii", sep = "")),
                                                               expression(italic("Calanus glacialis")), 
                                                               expression(italic("Calanus hyperboreus")), 
                                                               expression(paste(italic("Calanus "), "spp.", sep = "")), 
                                                               expression(paste(italic("Calanus "), "spp. Nauplii", sep = ""))
  ))+ 
  theme_classic() +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        axis.text.x = element_text(size=28),
        axis.text.y = element_text(size = 28), 
        legend.text = element_text(size = 25),
        legend.text.align = 0,
        axis.title = element_text(size = 35), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        plot.title = element_text(size = 35, hjust = 0.5))+
  scale_x_discrete(labels = c("Avant\ndÃ©bÃ¢cle", "0-20 j.", "20-40 j.", "40-60 j.", "60-80 j.", "80+"))+
  labs(y = "Moyenne de carbone ingÃ©rÃ©/poisson (mg)", x = "Nombre de jours depuis la dÃ©bÃ¢cle")
preys_carbon_OWD
ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/preys_carbon_OWD.png", plot = preys_carbon_OWD, dpi = 500, width = 17, height = 14, bg = "transparent")
#le faire pour des catÃ©gories de succÃ¨s alimentaire


carbon_input4 <- aggregate(carbon_mg ~ prey_id_comb + open_water_day + unique_fish_id, data = gutcontent2, FUN = sum)
carbon_input5 <- aggregate(carbon_mg ~ prey_id_comb + open_water_day, data = carbon_input4, FUN = mean)
carbon_input6 <- aggregate(carbon_mg ~ open_water_day, data = carbon_input5, FUN = sum)
carbon_input_caspC <- aggregate(carbon_mg ~ open_water_day, 
                                data = carbon_input4[carbon_input5$prey_id_comb %in% 
                                                       c("calanus glacialis c", 
                                                         "calanus hyperboreus c", 
                                                         "calanus sp c"),], FUN = sum)

ggplot()+
  geom_point(data = carbon_input6, mapping = aes(x=open_water_day, y = carbon_mg), color = "black")+
  geom_point(data = carbon_input_caspC, mapping = aes(x=open_water_day, y = carbon_mg), color = "#990F26")+
  geom_smooth(method = "loess", span = 0.75,data = carbon_input6, mapping = aes(x=open_water_day, y = carbon_mg), color = "black", fill = "grey") +
  geom_smooth(method = "loess", span = 0.75, data = carbon_input_caspC, mapping = aes(x=open_water_day, y = carbon_mg), color = "#990F26", fill = "#990F26")+
  theme_classic() +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        axis.text.x = element_text(size=28),
        axis.text.y = element_text(size = 28), 
        legend.text = element_text(size = 22),
        legend.text.align = 0,
        axis.title = element_text(size = 30), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        plot.title = element_text(size = 30, hjust = 0.5))+
  scale_x_continuous(breaks = c(-20, 0, 20, 40, 60, 80, 100))+
  scale_y_continuous(breaks = c(0,0.25,0.5,0.75,1,1.25))

```

# Discarded code
```{r dfish transformations discarded}

# boxcox2 <- function(x){
#   if(any(x < 0, na.rm  = TRUE)) {
#     pt <- car::powerTransform(x, family = "bcnPower") 
#     lambda <- pt$lambda
#     gamma <- pt$gamma
#     bc <- car::bcnPower(x, lambda, gamma = gamma)
#   } else {pt <- car::powerTransform(x)
#   lambda <- pt$lambda
#   bc <- car::bcPower(x, lambda)}
#   return(bc)
# }
# 
# dfish_transf <- dfish %>% select(-region) %>%
#   mapply(FUN = boxcox2) %>% as.data.frame() %>% mutate(region = fish$region)


# 
# reg <- unique(gutcontent$region)
# bu <- data.frame(region = as.character(reg[1]), year = 2009, CIS_break_up_date = as.Date("2009-07-02"))
# bu <- rbind(bu, data.frame(region = as.character(reg[1]), year = 2010, CIS_break_up_date = as.Date("2010-06-11")))
# bu <- rbind(bu, data.frame(region = as.character(reg[1]), year = 2014, CIS_break_up_date = as.Date("2014-06-25")))
# bu <- rbind(bu, data.frame(region = as.character(reg[1]), year = 2015, CIS_break_up_date = as.Date("2015-06-11")))
# bu <- rbind(bu, data.frame(region = as.character(reg[2]), year = 2010, CIS_break_up_date = as.Date("2010-08-13")))
# bu <- rbind(bu, data.frame(region = as.character(reg[2]), year = 2016, CIS_break_up_date = as.Date("2016-07-30")))
# bu <- rbind(bu, data.frame(region = as.character(reg[2]), year = 2018, CIS_break_up_date = as.Date("2018-08-20")))
# bu <- rbind(bu, data.frame(region = as.character(reg[3]), year = 2010, CIS_break_up_date = as.Date("2010-08-06")))
# bu <- rbind(bu, data.frame(region = as.character(reg[3]), year = 2011, CIS_break_up_date = as.Date("2011-07-30")))
# bu <- rbind(bu, data.frame(region = as.character(reg[3]), year = 2014, CIS_break_up_date = as.Date("2014-09-03")))
# bu <- rbind(bu, data.frame(region = as.character(reg[3]), year = 2015, CIS_break_up_date = as.Date("2015-08-20")))
# bu <- rbind(bu, data.frame(region = as.character(reg[3]), year = 2016, CIS_break_up_date = as.Date("2016-07-30")))
# bu <- rbind(bu, data.frame(region = as.character(reg[4]), year = 2010, CIS_break_up_date = as.Date("2010-07-16")))
# bu <- rbind(bu, data.frame(region = as.character(reg[4]), year = 2011, CIS_break_up_date = as.Date("2011-05-21")))
# bu <- rbind(bu, data.frame(region = as.character(reg[4]), year = 2015, CIS_break_up_date = as.Date("2015-05-28")))
# bu <- rbind(bu, data.frame(region = as.character(reg[4]), year = 2016, CIS_break_up_date = as.Date("2016-06-11")))
# bu <- rbind(bu, data.frame(region = as.character(reg[4]), year = 2017, CIS_break_up_date = as.Date("2017-06-11")))
# bu <- rbind(bu, data.frame(region = as.character(reg[5]), year = 2011, CIS_break_up_date = as.Date("2011-07-16")))
# bu <- rbind(bu, data.frame(region = as.character(reg[5]), year = 2016, CIS_break_up_date = as.Date("2016-07-16")))
# bu <- rbind(bu, data.frame(region = as.character(reg[5]), year = 2017, CIS_break_up_date = as.Date("2017-07-09")))
# bu <- rbind(bu, data.frame(region = as.character(reg[5]), year = 2018, CIS_break_up_date = as.Date("2018-07-23")))
# bu <- rbind(bu, data.frame(region = as.character(reg[6]), year = 2014, CIS_break_up_date = as.Date("2014-06-04")))
# bu <- rbind(bu, data.frame(region = as.character(reg[6]), year = 2015, CIS_break_up_date = as.Date("2015-06-04")))
# bu <- rbind(bu, data.frame(region = as.character(reg[6]), year = 2016, CIS_break_up_date = as.Date("2016-05-14")))
# bu <- rbind(bu, data.frame(region = as.character(reg[6]), year = 2018, CIS_break_up_date = as.Date("2018-06-04")))
# bu <- rbind(bu, data.frame(region = as.character(reg[7]), year = 2015, CIS_break_up_date = as.Date("2015-05-21")))
# bu <- rbind(bu, data.frame(region = as.character(reg[8]), year = 2015, CIS_break_up_date = as.Date("2015-07-23")))
# bu <- rbind(bu, data.frame(region = as.character(reg[8]), year = 2016, CIS_break_up_date = as.Date("2016-07-23")))
# bu <- rbind(bu, data.frame(region = as.character(reg[9]), year = 2017, CIS_break_up_date = as.Date("2017-01-01")))
# 
#  Question 3 Comme Cusa et al.
# 
# FO and %Pi were measured using the following equations:
# FO=(NiâN) %Pi=(âSiââSti )Ã100
# in which Ni is the number of stomachs with a given prey i in their stomach
# N is the total number of stomachs excluding empty stomachs.
# Si is the total weight of prey i from all stomachs
# Sti is the total prey weight of all stomachs containing prey i
# 
# ```{r comme Cusa et al 2019}
# dpreys_combTF <- as.data.frame(apply(dpreys_comb[,c(22:42)], MARGIN = 2, FUN = as.logical))
# dpreys_combTF$region <- dpreys_comb$region
# 
# preys <- data.frame(num_stom = colSums(dpreys_combTF[-22]))
# preys <- preys %>% mutate(FO = num_stom/339, 
#                           Si = aggregate(data = gutcontent2, carbon_mg ~ prey_id_comb, FUN = sum)$carbon_mg, 
#                           Sti = 1:21)
# rownames(preys) <- colnames(dpreys_comb[,c(22:42)])
# 
# for(i in rownames(preys)){
#   St <- dpreys_comb$carbon_mg[dpreys_comb[,which(colnames(dpreys_comb) == i)]>0] %>% sum
#   preys[i,]$Sti <- St
# }
# 
# preys$PI_percent <- preys$Si/preys$Sti * 100
# 
# #pour les rÃ©gions
# dpreys <- aggregate( . ~ region,data = dpreys_combTF, FUN = sum)
# preys_reg <- data.frame(t(dpreys[-1]))
# colnames(preys_reg) <- dpreys[,1]
# tot <- aggregate(unique_fish_id ~ region, data = dpreys_comb, FUN=length)
# 
# FO_reg <- data.frame(row.names = rownames(preys_reg))
# for(i in colnames(preys_reg)){
#   print(i)
#   assign(x = i, preys_reg[,i]/tot[tot$region == i, "unique_fish_id"])
#   FO_reg[,paste(i)] <- get(i)
# }
# 
# Si <- aggregate(data = gutcontent2, carbon_mg ~ prey_id_comb + region, FUN = sum)
# Si <- reshape(Si, direction = "wide", 
#         idvar = "prey_id_comb",
#         timevar = "region")
# Si<- Si[order(Si$prey_id_comb),]
# 
# for(i in rownames(preys)){
#   for(j in colnames(FO_reg)){
#     St <- dpreys_comb$carbon_mg[dpreys_comb[,which(colnames(dpreys_comb) == i)]>0 ] %>% sum
#     print(St)
#   }
```
