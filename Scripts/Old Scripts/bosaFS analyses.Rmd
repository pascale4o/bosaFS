---
title: "bosaFS analyses"
author: "Pascale Caissy"
date: '2021-03-11'
output:
  html_document:
    toc: true
    toc_depth: 2

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("tidyverse")
library("FactoMineR")
library("ggplot2")
library("ggfortify")
library("reshape2")
library("nlme")
library("vegan")
```


```{r look at prey matrix, echo=FALSE}
dfish <-read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/fish_data_PC_20210107.csv", check.names = FALSE) %>% select(-1)

gutcontent2 <- read.csv("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/gutcontent_bosa_carbon20210121.csv")%>% select(-X)
gutcontent2$prey_id_comb <- with(gutcontent2, ifelse( prey_reass %in% c("triconia borealis c", "oithona similis c", "onceaidae sp c", "oncea sp c", "cyclopoid sp c"), "cyclopoidae sp c", 
                                  ifelse( prey_reass %in% c("appendicularian sp", "fritillaria sp", "oikopleura sp"), "appendicularia", 
                                         ifelse( prey_reass %in% c("calanus sp n", "calanus glacialis n"), "calanus sp n",
                                                ifelse(prey_reass %in% c("calanoid sp", "calanoid sp c", "heterorhabdus norvegicus c", "metridia longa c", "chiridus sp c", "acartia sp c", "eurytemora sp c", "pseudocalanus sp/acartia sp c", "paraheterorhabdus compactus c", "paraeuchaeta sp c", "scolecithricella sp c", "spinocalanus sp c", "microcalanus sp c"), "other calanoid sp c", #calanoid line 
                                                       ifelse(prey_reass %in% c("calanoid sp n", "acartia sp n", "pseudocalanus sp/metridia longa n", "metridia longa n", "cyclopoid n", "microcalanus sp n", "microcalanus sp  n", "oithona similis n", "cyclopoid sp n", "unknown n"), "other copepodite and n", 
                                                              ifelse(prey_reass %in% c("egg","egg sack"), "egg",
                                                                            ifelse(prey_reass %in% c("fecal pellet","radiolarian sp","vers", "unknown", "chaetognath sp", "vertebrae", "trematoda sp", "parasite","polychaetae larvae", "digested matter", "crustacea sp meta", "amphipod sp", "decapoda sp meta", "euphausiacea sp", "decapoda sp", "boroecia maxima", "cirripedia sp", "cirripedia sp n", "podon sp", "coscinodiscus sp"), "other",
                                                                                   ifelse(prey_reass %in% c("unknown c", "harpacticoid sp c", "unknown nc"),"other copepodite and n",
                                                                                                 ifelse(prey_reass %in% c("calanus sp c", "calanus finmarchicus c", "calanus hyperboreus c"), "other calanus sp c", 
                                                                                                        ifelse(prey_reass %in% c("bivalve larvae","limacina helicina"), "other", #avant étaient séparés,puis mis dans mollusca, mais finalement c'Est vraiment un apport très faible
                                                                                                               as.character(prey_reass))))))))))))
#méthode de catégorisation: utiliser d'abord la taxonomie pour regrouper ensemble. Vérifier à la fois l'apport en nombre et en %carbone pour chaque catégorie. Rassemblé dans une autre catégorie quand représente -1% carbone et -5% du nombre de proies.

table(gutcontent2$prey_id_comb)/24646
tapply(gutcontent2$carbon_mg, INDEX = list(gutcontent2$prey_id_comb), FUN = sum, na.rm = TRUE)/sum(gutcontent2$carbon_mg, na.rm = TRUE)
```

```{r prep données}
#Beaufort Sea: Mackenzie Shelf, Amundsen Gulf Maud
#Kitikmeot: Coronation Maud, Larsen Sound, Peel Sound
#Baffin Bay: North Water, Lancaster Sound, NW Baffin Bay
dfish$province <- with(dfish, ifelse(region %in% c("Mackenzie Shelf", "Amundsen Gulf Mouth"), "Beaufort Sea",
                                    ifelse(region %in% c("Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound"), "Kitikmeot",
                                           ifelse(region == "NEG", "Greenland Sea",
                                                  "NW Baffin Bay"))))
reg_initials <- data.frame(region = levels(dfish$region), initials = c("AGM", "CM", "LS", "LV", "MS", "NEG", "NW", "PS", "WBB"))

dfish <- merge(dfish, reg_initials)
gutcontent2 <- merge(gutcontent2, reg_initials)

dfish$region_year <- as.factor(paste(dfish$initials, dfish$year))
gutcontent2$region_year <- as.factor(paste(gutcontent2$initials, gutcontent2$year))

prey_matrix_comb2 <- data.table::dcast(data.table::setDT(gutcontent2), unique_fish_id~prey_id_comb, length) %>% merge(., dfish[,c("unique_fish_id", "region_year", "region", "station", "open_water_day","surf_sal_kgm3", "surf_temp_degC", "NASC_zoo", "indstandard", "prof_mel", "est_standard_length", "fish_cond", "feeding_success")]) %>% select(-unique_fish_id)

dfish$region_year <- ordered(dfish$region_year, levels = c("MS 2009","MS 2010","MS 2014","MS 2015",
                                                           "AGM 2015", 
                                                           "CM 2011" ,"CM 2016","CM 2017","CM 2018",
                                                           "LV 2010", "LV 2016","LV 2018",
                                                           "PS 2010","PS 2011","PS 2014","PS 2015","PS 2016",
                                                           "LS 2010","LS 2011","LS 2015" ,"LS 2016","LS 2017",
                                                           "NW 2014","NW 2016", "NW 2018",
                                                           "WBB 2015","WBB 2016",
                                                           "NEG 2017"
                                                           ))
station_data <- aggregate(data = dfish, unique_fish_id ~ region_year + station + surf_temp_degC + surf_sal_kgm3 + open_water_day + NASC_zoo + indstandard + prof_mel, length)
```

# Section 1. Analyses multivariées

## Environnement
### PCA des régions années et conditions physiques

```{r PCA env}
env_pca <- station_data%>% select(surf_temp_degC, surf_sal_kgm3, open_water_day, region_year, prof_mel) %>% PCA(quali.sup = c(4), graph = FALSE)

station_data$pc1 <- env_pca$ind$coord[, 1]
station_data$pc2 <- env_pca$ind$coord[, 2]

pca.vars <- env_pca$var$coord %>% data.frame
pca.vars$vars <- rownames(pca.vars)

posArrowsX <- c(4, 4, 4,4)
posArrowsY<- c(4,4,4,4)
colours <- c(pals::stepped(n=24)[13:16], pals::polychrome(n=4)[4], pals::stepped(n=24)[5:11], pals::stepped2(n=20)[13], pals::stepped(n=24)[c(1:4,17:20)],pals::stepped3(n=16)[16],pals::stepped(n=24)[21:23], pals::stepped3(n=20)[c(5:6)], "red")
names(colours) <- levels(station_data$region_year)
gg_PCA_env <- ggplot() +  
  geom_point(data = station_data, aes(x = pc1, y = pc2, colour = region_year), size = 2.5)+
  #scale_colour_manual(values = colours)+
  coord_equal()+
  theme_classic()+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill=alpha('white', 0.4)))+
  labs(x= paste("PC1 (", round(env_pca$eig["comp 1", "percentage of variance"], digits = 2), "%)"),
       y= paste("PC2 (", round(env_pca$eig["comp 2", "percentage of variance"], digits = 2), "%)")) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_segment(data = pca.vars, aes(x = 0, xend = Dim.1*3, y = 0, yend = Dim.2*3),
               arrow = arrow(length = unit(0.025, "npc"), type = "open"), 
               lwd = 0.5) + 
  geom_text(data = pca.vars, 
            aes(x = Dim.1*posArrowsX, y =  Dim.2*posArrowsY, label = vars), 
            check_overlap = FALSE)+
  scale_color_manual(values = colours)
gg_PCA_env  


```

Les clusters se font par région-année. L'Ouest et l'est semblent se mélanger, mais l'Arctique canadien (Kitikmeot) semble relativement distinct dans ses caractéristiques océanographiques. Le Mackenzie Shelf en 2010 se démarque particulièrement dû aux fortes températoires et sa faible profondeur de mélange. 2 stations de Peel Sound en 2014 semblent être particulièrement froides avec une couche de mélange très profonde, tout comme une statioin du NEG. Les deux stations du Lancaster Sound en 2010 se démarquent du cluster de LS. 


### PCA des régions-années, conditions environnementales et zoo

```{r PCA envzoo}
envzoo_pca <- station_data%>% select(surf_temp_degC, surf_sal_kgm3, open_water_day, NASC_zoo, region_year, prof_mel) %>% PCA(quali.sup = c(5), graph = FALSE)

station_data$pc1_zoo <- envzoo_pca$ind$coord[, 1]
station_data$pc2_zoo <- envzoo_pca$ind$coord[, 2]

pca.vars <- envzoo_pca$var$coord %>% data.frame
pca.vars$vars <- rownames(pca.vars)

posArrowsX <- c(4, 4, 4,4,4)
posArrowsY<- c(4,4,4,4,4)
gg_PCA_envzoo <- ggplot() +  
  geom_point(data = station_data, aes(x = pc1_zoo, y = pc2_zoo, colour = region_year), size = 2.5)+
  #scale_colour_manual(values = colours)+
  coord_equal()+
  theme_classic()+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill=alpha('white', 0.4)))+
  labs(x= paste("PC1 (", round(envzoo_pca$eig["comp 1", "percentage of variance"], digits = 2), "%)"),
       y= paste("PC2 (", round(envzoo_pca$eig["comp 2", "percentage of variance"], digits = 2), "%)")) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_segment(data = pca.vars, aes(x = 0, xend = Dim.1*3, y = 0, yend = Dim.2*3),
               arrow = arrow(length = unit(0.025, "npc"), type = "open"), 
               lwd = 0.5) + 
  geom_text(data = pca.vars, 
            aes(x = Dim.1*posArrowsX, y =  Dim.2*posArrowsY, label = vars), 
            check_overlap = FALSE)+
  scale_color_manual(values = colours)
gg_PCA_envzoo

```
On a encore MS 2010 qui se distingue particulièrement. L'Arctique canadien se discrimine un peu moins, malgré que CM, LV et PS semblent appartenir au même groupe.

### PCA des régions-années, conditions environnementales et données de filets de larves

```{r PCA envfish}
envfish_pca <- station_data%>% select(surf_temp_degC, surf_sal_kgm3, open_water_day, indstandard, region_year, prof_mel) %>% PCA(quali.sup = c(5), graph = FALSE)

station_data$pc1_fish <- envfish_pca$ind$coord[, 1]
station_data$pc2_fish <- envfish_pca$ind$coord[, 2]

pca.vars <- envfish_pca$var$coord %>% data.frame
pca.vars$vars <- rownames(pca.vars)

posArrowsX <- c(4, 4, 4,4,4)
posArrowsY<- c(4,4,4,4,4)
gg_PCA_envfish <- ggplot() +  
  geom_point(data = station_data, aes(x = pc1_fish, y = pc2_fish, colour = region_year), size = 2.5)+
  #scale_colour_manual(values = colours)+
  coord_equal()+
  theme_classic()+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill=alpha('white', 0.4)))+
  labs(x= paste("PC1 (", round(envfish_pca$eig["comp 1", "percentage of variance"], digits = 2), "%)"),
       y= paste("PC2 (", round(envfish_pca$eig["comp 2", "percentage of variance"], digits = 2), "%)")) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_segment(data = pca.vars, aes(x = 0, xend = Dim.1*3, y = 0, yend = Dim.2*3),
               arrow = arrow(length = unit(0.025, "npc"), type = "open"), 
               lwd = 0.5) + 
  geom_text(data = pca.vars, 
            aes(x = Dim.1*posArrowsX, y =  Dim.2*posArrowsY, label = vars), 
            check_overlap = FALSE)+
  scale_color_manual(values = colours)
gg_PCA_envfish


```

### PCA des régions-années, et relations entre l'environnement et l'abondance de zoo et de larves

```{r PCA env bio total}
envbio_pca <- station_data%>% select(surf_temp_degC, surf_sal_kgm3, open_water_day, NASC_zoo,indstandard, region_year, prof_mel) %>% PCA(quali.sup = c(6), graph = FALSE)

station_data$pc1_bio <- envbio_pca$ind$coord[, 1]
station_data$pc2_bio <- envbio_pca$ind$coord[, 2]

pca.vars <- envbio_pca$var$coord %>% data.frame
pca.vars$vars <- c("Température", "Salinté", "Nombre de jours\ndepuis débâcle", "Zoo", "Larves", "Profondeur\nde mélange")

posArrowsX <- c(2.5, 3.5, 3,3,4,4)
posArrowsY<- c(5.5,3.5,3.75,4,3.75,4)
gg_PCA_bio <- ggplot() +  
  geom_point(data = station_data, aes(x = pc1_bio, y = pc2_bio, colour = region_year), size = 4)+
  #scale_colour_manual(values = colours)+
  coord_equal()+
  theme_classic()+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        legend.text=element_text(size=25),
        legend.title= element_text(size=28),
        axis.title = element_text(size = 25),
        axis.text = element_text(size = 18))+
  labs(x= paste("PC1 (", round(envbio_pca$eig["comp 1", "percentage of variance"], digits = 2), "%)"),
       y= paste("PC2 (", round(envbio_pca$eig["comp 2", "percentage of variance"], digits = 2), "%)"), size= 15) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_segment(data = pca.vars, aes(x = 0, xend = Dim.1*3, y = 0, yend = Dim.2*3),
               arrow = arrow(length = unit(0.025, "npc"), type = "open"), 
               lwd = 0.5) + 
  geom_text(data = pca.vars, 
            aes(x = Dim.1*posArrowsX, y =  Dim.2*posArrowsY, label = vars), 
            check_overlap = FALSE, size = 7)+
  scale_color_manual(values = colours, name = "Région année")
gg_PCA_bio

ggsave("/Users/pascalecaissy/Dropbox/MSc 2019-2020/Hiver 2021/Colloque/PCA.jpg", plot = gg_PCA_bio, dpi = 500, width = 14, height = 10, bg = "transparent")
```

On a encore la démarcation Kitikmeot reste du groupe, aninsi que MS 2010 qui est seul. L'est et l'ouest se ressemblent beaucoup avec quelques stations qui font exception.

## Ajoutons les larves
```{r PCA and plot, eval = TRUE}
fish_pca <-  dfish %>% select(region_year, feeding_success, surf_temp_degC, surf_sal_kgm3, open_water_day, NASC_zoo,indstandard, prof_mel, est_standard_length, fish_cond) %>%PCA(quali.sup = c(1), quanti.sup = c(2), graph = FALSE)

dfish$pc1_allfish <- fish_pca$ind$coord[, 1]
dfish$pc2_allfish <- fish_pca$ind$coord[, 2]

pca.vars <- fish_pca$var$coord %>% data.frame
pca.vars$vars <- rownames(pca.vars)
pca.vars.m <- reshape2::melt(pca.vars, id.vars = "vars")
pca.var.sup <- fish_pca$quanti.sup$coord %>% data.frame

posArrowsX <- c(4, 4, 4, 4,4,4,4,4)
posArrowsY <- c(4, 4, 4, 4,4,4,4,4)
p_transf <- ggplot() +  
  geom_jitter(data = dfish, aes(x = pc1_allfish, y = pc2_allfish, colour = region_year), size = 2.5)+
  coord_equal()+
  theme_classic()+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        legend.text=element_text(size=8))+
  labs(x= paste("PC1 (", round(fish_pca$eig["comp 1", "percentage of variance"], digits = 2), "%)"),
       y= paste("PC2 (", round(fish_pca$eig["comp 2", "percentage of variance"], digits = 2), "%)")) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_point(size = 2) +
  geom_segment(data = pca.vars, aes(x = 0, xend = Dim.1*4, y = 0, yend = Dim.2*4),
               arrow = arrow(length = unit(0.025, "npc"), type = "open"), 
               lwd = 0.5) + 
  geom_text(data = pca.vars, 
            aes(x = Dim.1*posArrowsX, y =  Dim.2*posArrowsY, label = vars), 
            check_overlap = FALSE, size = 5)+ 
  scale_color_manual(values = colours, name = "Region") +
  geom_segment(data = pca.var.sup, aes(x = 0, xend = Dim.1*5, y = 0, yend = Dim.2*5),
             arrow = arrow(length = unit(0.025, "npc"), type = "open"),
             lwd = 0.5, lty = "dotted") + 
  geom_text(data = pca.var.sup, 
            aes(x = Dim.1*4, y =  Dim.2*4,
                label = "Succès\nalimentaire"), size = 5, col = '#868B8D')
p_transf
ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/PCA_fish.png", plot = p_transf, dpi = 500, width = 14, height = 10, bg = "transparent")
```

Les clusters se forment par station au minimum et au niveau de la région année, dans certains cas de la région-même. Donc la variation est vraiment due à l'environnement et aux poissons eux-mêmes plutôt qu'à la localisation elle-même. Et les clusters ne se distinguent pas entre l'Est et l'Ouest: tout est mélangé avec le Kitikmeot qui se distingue légèrement.

## Contenus stomacaux

### Cusa et al.

```{r Cusa et al.}
tot_preys2 <- prey_matrix_comb2 %>% select (c(1:11)) %>% rowSums()
prey_matrix_comb2[,1:11] <- prey_matrix_comb2[,1:11]/tot_preys2
  
FO_station <- prey_matrix_comb2 %>% aggregate(data = .,. ~ region_year+region+station, FUN = mean, na.rm = TRUE)

FO_station$shannon <- diversity(x = FO_station[,c(4:14)], index = "shannon", MARGIN = 1)
FO_station$simpson <- diversity(x = FO_station[,c(4:14)], index = "simpson", MARGIN = 1)

tot_carbon <- aggregate(carbon_mg ~ unique_fish_id + as.factor(station) + region_year, data = gutcontent2, FUN = sum)
colnames(tot_carbon) <- c("unique_fish_id", "station", "region_year", "sum_carbon")
A <- gutcontent2 %>% merge(tot_carbon, intersect(names(.), names(tot_carbon))) %>% 
  mutate(BDC_perc = carbon_mg/sum_carbon)

perc_carbon_fish_preys <- aggregate(BDC_perc ~ unique_fish_id + prey_id_comb + station + region_year + region, data= A, FUN = sum) %>% tidyr::spread(prey_id_comb, BDC_perc)
perc_carbon_fish_preys[is.na(perc_carbon_fish_preys)] <- 0

Xa_station <- perc_carbon_fish_preys %>% aggregate(data = .,. ~ region_year+station, FUN = mean, na.rm = TRUE)

Xap_station <- perc_carbon_fish_preys %>% aggregate(data = ., .~region_year+station, FUN = function(x){mean(x[x>0])})

is.nan.data.frame <- function(x){ do.call(cbind, lapply(x, is.nan))}
Xap_station[is.nan(Xap_station)] <- 0

env_reg_year <-  FO_station %>% select(1:2,15:22)%>%
  aggregate(. ~ region_year+region, data = ., FUN= mean, na.rm = TRUE)

preys_reg_year <- FO_station %>% select(-station)%>%
  aggregate(. ~ region_year+region, data = ., FUN= mean, na.rm = TRUE)
rownames(preys_reg_year)<- env_reg_year$region_year
rownames(env_reg_year)<- env_reg_year$region_year
carb_reg_year <- perc_carbon_fish_preys %>% aggregate(data = ., . ~ region_year+region, FUN = mean) %>% select(-unique_fish_id, -station)
rownames(carb_reg_year)<- env_reg_year$region_year
```


### NMDS
```{r CA, eval = TRUE}
MDS2 <- metaMDS(carb_reg_year[,3:13], try = 40)
stressplot(MDS2)
MDS2
ord_env2<- envfit(MDS2 ~ surf_temp_degC +surf_sal_kgm3 + open_water_day + NASC_zoo + indstandard + prof_mel, data=env_reg_year, perm=999)

par(mar=c(5.1, 4.1, 4.1, 8.1), xpd=TRUE)
plot(MDS2, bty = "l")
plot(ord_env2)
orditorp(MDS2,display="sites", labels = F, group = carb_reg_year$region, col = c(1:9))
orditorp(MDS2,display="species", air = 0.5)
 ordiellipse(MDS2, group = carb_reg_year$region,
           lty = 1, col = "grey90")
 legend("topright", inset = c(-0.5,0),
       col = c(1:8),
       lty = 1,
       legend = levels(carb_reg_year$region))
 text(x = -1.25, y = 0.5, labels=paste("Stress =", round(MDS2$stress, digits = 2), sep = " "))
 
 
# First create a data frame of the scores from the individual sites.
# This data frame will contain x and y values for where sites are located.
data_scores <- as.data.frame(scores(MDS2))

# Now add the extra aquaticSiteType column
data_scores <- cbind(data_scores, region = carb_reg_year$region)
data_scores$region <- ordered(as.factor(data_scores$region),levels = c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "NEG"))
#colnames(data_scores)[3] <- "region"

# Next, we can add the scores for species data
species_scores <- as.data.frame(scores(MDS2, "species"))
rownames(species_scores) <- c("Appendicularia", "Calanus glacialis", "Calanus spp.\nNauplii", "Cyclopoida", "Oeuf", "Autre", "Calanoida", "Calanus spp.", "Autres\ncopépodites/naupliis", "Pseudocalanus spp.","Pseudocalanus spp.\nNauplii")
# Add a column equivalent to the row name to create species labels
species_scores$species <- rownames(species_scores)

vec.df<-as.data.frame(ord_env2$vectors$arrows*sqrt(ord_env2$vectors$r)) %>% mutate(vars = c("Température", "Salinité", "Nombre de\njours depuis\ndébâcle", "Zoo", "Larves", "Profondeur\nde mélange"))

# Now we can build the plot!
find_hull <- function(df) df[chull(df$NMDS1, df$NMDS2), ]
hulls <- plyr::ddply(data_scores, "region", find_hull)
colNMDS <- colours[c(1,5,6,10,13,18,23,26,28)] 
names(colNMDS) <- c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "NEG")
segX <- c(1.3, 1.3, 1.1, 1.3,1.3, 1.3)
segY <- c(1.3, 1.3, 1.4, 1.3,1.3, 1.3)
NMDSplot <- ggplot() +
  #geom_text(data = species_scores, aes(x = NMDS1, y = NMDS2, label = species),
  #          alpha = 0.5, size = 5) +
  ggrepel::geom_text_repel(data = species_scores, aes(x = NMDS1, y = NMDS2, label = species),
            alpha = 0.5, size = 5)+
  geom_point(data = data_scores, aes(x = NMDS1, y = NMDS2,color = region))+
             
  geom_polygon(data = hulls,mapping = aes(x = NMDS1, y = NMDS2, colour = region), fill =NA)+
  annotate(geom = "label", x = -0.5, y = 1.1, size = 10,
           label = paste("Stress: ", round(MDS2$stress, digits = 3))) +
  theme_classic() +
  theme(legend.position = "right",
        text = element_text(size = 24),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill=alpha('white', 0.4)))+
  scale_color_manual(values = colNMDS, name = "Région")+
  geom_segment(data=vec.df,aes(x=0,xend=NMDS1*1.15,y=0,yend=NMDS2*1.15),
      arrow = arrow(length = unit(0.5, "cm")),colour="black", lty = "dotted") +
  geom_text(data = vec.df, aes(x = NMDS1*segX, y = NMDS2*segY, label = vars),  size = 5)+
  scale_x_continuous(breaks = c(-1, -0.5, 0, 0.5, 1), limits = c(-1,1))
NMDSplot
ggsave("/Users/pascalecaissy/Dropbox/MSc 2019-2020/Hiver 2021/Colloque/NMDS.jpg", plot = NMDSplot, dpi = 500, width = 14, height = 10, bg = "transparent")
```

# Section 2. Modèles de succès alimentaire

## Explo préliminaire

```{r explo Question 2 poissons}
#taille des poissons
plot(est_standard_length ~ region, data = dfish, las = 2)
tapply(dfish$est_standard_length, INDEX = list(dfish$region, dfish$year), FUN = mean)
tapply(dfish$est_standard_length, INDEX = list(dfish$region, dfish$year), FUN = median)

cor(dfish$est_standard_length, dfish$open_water_day)
plot(dfish$est_standard_length~dfish$open_water_day)
lattice::xyplot(est_standard_length ~ open_water_day|region, data = dfish)


#taille et carbone
plot(dfish$carbon_mg ~ dfish$fish_WW)
plot(dfish$carbon_mg ~ dfish$est_standard_length) #la quantité de carbone ingérée demeure faible même si les poissons sont gros, mais certains gros individus vont arriver à toucher le jackpot

#taille et succès alimentaire
plot((feeding_success)~est_standard_length, data = dfish)
plot(log10(feeding_success)~est_standard_length, data = dfish)
summary(lm(log10(feeding_success) ~ est_standard_length, data = dfish)) # il va falloir corriger pour la taille dans les modèles: elle semble influencer le succès alimentaire

plot(log10(feeding_success) ~ est_standard_length, data= dfish[dfish$est_standard_length>=25,]) 
plot(log10(feeding_success) ~ est_standard_length, data= dfish[dfish$est_standard_length<25,])

plot(fish_cond ~ est_standard_length,data = dfish) # les poissons plus gros n'ont pas nécessairement une meilleure condition physique, et je ne discerne pas vraiment un pattern indiquant une transition vers une autre forme
plot(log10(feeding_success) ~ fish_cond, data  = dfish) #augmentation de FS
plot(log10(feeding_success) ~ fish_cond, data= dfish[dfish$est_standard_length>=25,])
plot(log10(feeding_success) ~ fish_cond, data= dfish[dfish$est_standard_length<25,]) 
plot(fish_cond~feeding_success, data = dfish)
plot(fish_cond~log10(feeding_success), data = dfish) # légère augmentation quand FS augmente


dfish$size_catego <- with(dfish, ifelse(est_standard_length<10, "<10", 
                                        ifelse(est_standard_length >=10 & est_standard_length<15, "10-15",
                                               ifelse(est_standard_length>=15 & est_standard_length<20, "15-20",
                                                      ifelse(est_standard_length>=20 & est_standard_length<25, "20-25",
                                                             ">25")))))
dfish$logFS <- log10(dfish$feeding_success)
xyplot(logFS ~ fish_cond|size_catego, data = dfish)

```

```{r}
#FS et environnement
plot(logFS ~ NASC_zoo, data = dfish) #très légère augmentation mais rien de signifcatif
plot(logFS ~ surf_temp_degC, data = dfish) #un peu en parabole
plot(logFS ~ surf_sal_kgm3, data = dfish) #légère augmentation
plot(logFS ~ open_water_day, data = dfish) #augmentation
plot(logFS ~ indstandard, data = dfish)
dfish %>% select(logFS, open_water_day, surf_sal_kgm3, surf_temp_degC, NASC_zoo, fish_cond, indstandard) %>% plot
dfish %>% select(logFS, open_water_day, surf_sal_kgm3, surf_temp_degC, NASC_zoo, fish_cond, indstandard) %>% cor

 library(Hmisc)
dfish %>% select(logFS, open_water_day, surf_sal_kgm3, surf_temp_degC, NASC_zoo, fish_cond, indstandard) %>%as.matrix()%>% rcorr
#corrélation entre  débâcle et NASC_zoo, NASC_zoo et température
boxplot(logFS ~ region,data = dfish)
boxplot(feeding_success ~ region_year,data = dfish, las = 2)
boxplot(logFS ~ region_year,data = dfish, las = 2)

boxplot(logFS ~ province, data = dfish)
plot(feeding_success ~ region, data = dfish, las = 2) #pas mal similaire, mais toutes des valeurs bound à 0
plot(log10(feeding_success) ~ region, data = dfish, las = 2)
hist(dfish$feeding_success) #un beau neg binomial
hist(log10(dfish$feeding_success)) #normalish
lattice::bwplot(feeding_success ~ as.factor(year)|region, data = dfish)
lattice::bwplot(log10(feeding_success) ~ as.factor(year)|region, data = dfish) # variation LS, LV, MS, NW, PS
lattice::xyplot(log10(feeding_success) ~ (open_water_day)|region, data = dfish) #la variation individuelle est énorme toute région confondue
plot(feeding_success ~ as.factor(province), data = dfish)
plot(log10(feeding_success) ~ as.factor(province), data = dfish)

```

## FS ~ environnement

```{r modèles}
library(lme4)
library(lmerTest)
library(sjPlot)
library(glmmTMB)
mod.intercept <- lmerTest::lmer( logFS ~ 1 + (1|region), data = dfish )
summary(mod.intercept)
performance::icc(mod.intercept)
plot_model( mod.intercept, 
            type = "diag" )
#mixtes linéraires avec transfo
#modèle zoo et compétition
zoo_fish <- lme(logFS~indstandard + NASC_zoo, random = ~1|region, data = dfish)
summary(zoo_fish) #la compétition et l'abondance de macrozooplancton n'ont pas d'effet sur le succès alimentaire

#modèle débâcle et température
bu_temp <- lme(logFS~surf_temp_degC + surf_sal_kgm3 + open_water_day + NASC_zoo + indstandard + prof_mel, random = ~1|region, data = dfish)
summary(bu_temp) # la salinité et la date de débâcle influencent le succès alimentaire

bu_size2 <- lmer(logFS~surf_temp_degC + surf_sal_kgm3 + open_water_day + NASC_zoo + indstandard + prof_mel + est_standard_length + (1|region), data = dfish)
summary(bu_size2) # la salinité et la date de débâcle influencent le succès alimentaire

plot_model( bu_size2, 
             type = "pred", 
             pred.type = "fe", 
             terms = c("open_water_day", "surf_sal_kgm3"), 
             show.data = TRUE
            )

plot_model( bu_size2, 
             type = "pred", 
             pred.type = "fe", 
             terms = c("open_water_day", "NASC_zoo"), 
             show.data = TRUE
            )

plot_model( bu_size2, 
             type = "pred", 
             pred.type = "fe", 
             terms = c("open_water_day", "region"), 
             show.data = TRUE
            )

bu_size3 <- lme(logFS~surf_temp_degC + surf_sal_kgm3 + open_water_day*est_standard_length + NASC_zoo + indstandard + prof_mel, random = list(~1|region), data = dfish)
summary(bu_size3) # la salinité et la date de débâcle influencent le succès alimentaire


FS_cond <- lme(fish_cond~feeding_success, random = ~1|region, data = dfish)
summary(FS_cond) #le succès alimentaire n'a pas d'effet sur la condition physique


cond_size <- lme(fish_cond~surf_temp_degC + surf_sal_kgm3 + open_water_day + NASC_zoo + indstandard + prof_mel, random = list(~1|region, ~1|size_catego), data = dfish)
summary(cond_size)
```

### Figures
#### taille ~ regions
Pour justifier l'ajout de la taille comme covariable
```{r figure taille par régions-année}

ggplot(data = dfish)+
  geom_boxplot(mapping = aes(x = region, y = est_standard_length), outlier.shape = NA)+
  geom_jitter(mapping = aes(x = region, y = est_standard_length, color = region_year))+
  scale_color_manual(values = colours, name = "Region-year combination")+
  labs(x = "Region", y = "Standard length (cm)")+
  theme_classic()+
  theme(legend.position = "right",
        text = element_text(size = 24),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill=alpha('white', 0.4)))
```

#### Taille ~ OWD, FS ~ taille
```{r figure taille OWD}

ggplot(data = dfish)+
  geom_jitter(mapping = aes(x = open_water_day, y = est_standard_length, col = region_year))+
  scale_color_manual(values = colours, name = "Region-year combination")+
  labs(x = "Open water days", y = "Standard length (cm)")+
  theme_classic()+
  theme(legend.position = "right",
        text = element_text(size = 24),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill=alpha('white', 0.4)))


ggplot(data = dfish)+
  geom_point(mapping = aes(x = est_standard_length, y = log10(feeding_success), col = region_year))+
  scale_color_manual(values = colours, name = "Region-year combination")+
  labs(x = "Standard length (cm)", y = "log10(Feeding success)")+
  theme_classic()+
  theme(legend.position = "right",
        text = element_text(size = 24),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill=alpha('white', 0.4)))
```


#### Modèles
```{r figure conf int}
df_new <- data.frame(
  open_water_day = seq(from = min(dfish$open_water_day), to = max(dfish$open_water_day), length.out = 100),
  fish_cond = mean(dfish$fish_cond),
  region = "North Water",
  surf_temp_degC = mean(dfish$surf_temp_degC),
  surf_sal_kgm3 = mean(dfish$surf_sal_kgm3),
  NASC_zoo = mean(dfish$NASC_zoo),
  prof_mel = mean(dfish$prof_mel),
  indstandard = mean(dfish$indstandard),
  est_standard_length = mean(dfish$est_standard_length))
pred <- cbind(df_new, merTools::predictInterval(bu_size2, df_new))

ggplot() + 
  geom_line(data =pred, aes(open_water_day, fit)) +
  geom_ribbon(data =pred, aes(open_water_day, ymin = lwr, ymax = upr), alpha = .2) +
  geom_point(data = dfish, aes(open_water_day, y = logFS, color = region))






plotFS <- plot_model( bu_size2, 
             type = "pred", 
             pred.type = "fe", 
             terms = c("open_water_day"), 
             show.data = TRUE,
            title = "", colors = colNMDS,
            axis.title = c("Nombre de jours depuis la débâcle","log10(Succès alimentaire")
            )+
  theme_classic() +
  theme(legend.position = "right",
        text = element_text(size = 24),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill=alpha('white', 0.4)))

ggsave("/Users/pascalecaissy/Dropbox/MSc 2019-2020/Hiver 2021/Colloque/plotFS.jpg", plot = plotFS, dpi = 500, width = 14, height = 10, bg = "transparent")

plot_model( bu_size2, 
             type = "pred", 
             pred.type = "fe", 
             terms = c("surf_sal_kgm3"), 
             show.data = TRUE,
            title = ""
            )+
  theme_classic() +
  theme(legend.position = "right",
        text = element_text(size = 24),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill=alpha('white', 0.4)))+
  scale_color_manual(values = colNMDS, name = "Région")

plot_model( bu_size2, 
             type = "pred", 
             pred.type = "re", 
             terms = c("open_water_day", "region"), 
             show.data = TRUE,
            title = ""
            )
```

# Section 3. Proies et succès alimentaire

##FS ~ taille des proies
```{r explo Question 3 proies}
plot(prey_range_um/1000 ~ est_standard_length, data = dfish) # les grosses larves mangent à la fois de grosses et petites choses
plot(prey_min_um/1000 ~ est_standard_length, data = dfish)
plot(prey_max_um/1000 ~ est_standard_length, data = dfish)
plot(prey_median_um/1000 ~ est_standard_length, data = dfish) #vraiment rare que les larves, peu importe la taille, mangent de grosses affaires
plot(log10(feeding_success) ~ prey_median_um, data = dfish)
median(dfish[which(dfish$feeding_success > 0.001),"prey_median_um"])
plot(log10(feeding_success) ~ prey_max_um, data = dfish)
plot(log10(feeding_success) ~ prey_min_um, data = dfish)
plot(log10(feeding_success) ~ prey_range_um, data = dfish)
plot(log10(feeding_success) ~ prey_median_um, data = dfish)
plot((feeding_success) ~ prey_max_um, data = dfish)
plot((feeding_success) ~ prey_min_um, data = dfish)
plot((feeding_success) ~ prey_range_um, data = dfish)
plot((feeding_success) ~ prey_median_um, data = dfish)
#pas vraiment de relation entre taille des proies et FS

dfish$total_preys <- rowSums(dfish[,c(23:86)])
plot(total_preys ~ prey_max_um, data = dfish)
plot(total_preys ~ prey_min_um, data = dfish)
plot(total_preys~prey_range_um, data = dfish)
plot(total_preys~prey_median_um, data = dfish)
plot((feeding_success) ~ total_preys, data = dfish)
plot(log10(feeding_success) ~ total_preys, data = dfish)


FS_preySize <- lme(logFS ~ prey_median_um + prey_range_um + total_preys, random = list(~1|region, ~1|size_catego), data = dfish)
summary(FS_preySize)
```

## FS ~ prés absence de proies
```{r}
prey_matrix_comb3 <- prey_matrix_comb2
prey_matrix_comb3[, c(1:11)] <- as.data.frame(sapply(prey_matrix_comb3[,c(1:11)], as.logical))
prey_matrix_comb3[, c(1:11)] <- as.data.frame(sapply(prey_matrix_comb3[,c(1:11)], as.numeric))

for(i in 1:11){
  preyvec <- as.matrix(prey_matrix_comb3[,i])
  plot(log10(prey_matrix_comb3$feeding_success) ~ preyvec[,1])
  i = i+1
}

summary(lme(log10(feeding_success) ~ appendicularia + `calanus glacialis c` +`calanus sp n`+`cyclopoidae sp c`+`egg`+`other` + `other calanoid sp c`+`other calanus sp c`+`other copepodite and n`+`pseudocalanus sp c`+`pseudocalanus sp n`, data = prey_matrix_comb3))

colnames(prey_matrix_comb3) <- make.names(colnames(prey_matrix_comb3), unique = TRUE)
prey_matrix_comb3$logFS <- log10(prey_matrix_comb3$feeding_success)

summary(lme(as.formula(paste(colnames(prey_matrix_comb3)[24], "~",
        paste(colnames(prey_matrix_comb3)[c(1:11,21)], collapse = "+"),
        sep = "")), random = ~1|region, data = prey_matrix_comb3))


prey_matrix_comb3$size_catego <- with(prey_matrix_comb3, ifelse(est_standard_length<10, "<10", 
                                        ifelse(est_standard_length >=10 & est_standard_length<15, "10-15",
                                               ifelse(est_standard_length>=15 & est_standard_length<20, "15-20",
                                                      ifelse(est_standard_length>=20 & est_standard_length<25, "20-25",
                                                             ">25")))))
FS_preyType <- lme(as.formula(paste(colnames(prey_matrix_comb3)[24], "~",
        paste(colnames(prey_matrix_comb3)[c(1:11)], collapse = "+"),
        sep = "")), random = c(~1|region, ~1|size_catego), data = prey_matrix_comb3)
summary(FS_preyType)

```


```{r prey occurence, echo = FALSE, eval = FALSE}
freqtable <- as.data.frame(table(gutcontent2$prey_id_comb,gutcontent2$region))
freqtable$Var2 <- ordered(freqtable$Var2, c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "NEG"))
color = grDevices::colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]
colours_bar <- sample(color, size =15)
ggplot() +
  geom_bar(data =freqtable, mapping = aes(fill=Var1, y=Freq, x=Var2), position="fill", stat="identity") +
  scale_fill_manual(values =colours_bar)

freqtable2 <- as.data.frame(table(gutcontent2$prey_id_comb,gutcontent2$station))
ggplot() +
  geom_bar(data =freqtable2, mapping = aes(fill=Var1, y=Freq, x=Var2), position="fill", stat="identity") +
  scale_fill_manual(values =colours_bar)

carbon_input <- aggregate(carbon_mg ~ prey_id_comb + region, data = gutcontent2, FUN = sum)
ggplot() +
  geom_bar(data =carbon_input, mapping = aes(fill=prey_id_comb, y=carbon_mg, x=region), position="fill", stat="identity") +
  scale_fill_manual(values =colours_bar) + 
  labs(x = "", y = "")

carbon_input2 <- aggregate(carbon_mg ~ prey_id_comb + station, data = gutcontent2, FUN = sum)
ggplot() +
  geom_bar(data =carbon_input2, mapping = aes(fill=prey_id_comb, y=carbon_mg, x=station), position="fill", stat="identity") +
  scale_fill_manual(values =colours_bar) 

#en gros, bouffer des calanus = payant à souhait

```


# Autres
Je ne sais même pas si ce code roule enore donc ne pas en tenir compte. Je le garde au cas: c'est toujours pratique.

## Cours de stats avec Marc Mazerolle (sélection de modèles)

```{r mixed linear model, eval = FALSE, echo = FALSE}
#vérification ajustement des modèles lm----
lm.fs.untranf <- lm(feeding_success ~ open_water_day + fish_cond, data = dfish, na.action = na.omit)
plot(lm.fs.untranf)

lm.glob1 <- lm(log10(feeding_success) ~ open_water_day + fish_cond, data = dfish, na.action = na.omit)
summary(lm.glob1)

#pdf("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/glob1_res.pdf")
plot(rstudent(lm.glob1) ~ fitted(lm.glob1), ylab = "Résidus de Student", xlab = "Valeurs prédites")
#dev.off()

plot(hatvalues(lm.glob1), 
     ylab = "Hat values",
     xlab = "Observations", main = "Effet de levier")
abline(h = 2*3/324, lty = 2) #on a un effet de levier pour certaines valeurs, mais je ne crois pas qu'il soit trop

# pdf("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/glob1_cook.pdf")
plot(cooks.distance(lm.glob1),
     ylab = "Distance de Cook", 
     xlab = "Observations", 
     main = "Influence des observations")
abline(h = 3/(324-4), lty = 2) #rien en haut de 1, mais un bon nombre sont en haut du seuil
# dev.off()

lm.glob2 <- lm(log10(feeding_success) ~ surf_temp_degC + NASC_zoo + fish_cond, data = dfish, na.action = na.omit)
summary(lm.glob2)



# pdf("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/glob2_res.pdf")
plot(rstudent(lm.glob2) ~ fitted(lm.glob2), ylab = "Résidus de Student", xlab = "Valeurs prédites")
# dev.off()

plot(hatvalues(lm.glob2), ylab = "Hat values",
     xlab = "Observations", main = "Effet de levier")
abline(h = 2*4/324, lty = 2) #on a un effet de levier pour certaines valeurs, mais je ne crois pas qu'il soit trop

# pdf("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/glob2_cook.pdf")
plot(cooks.distance(lm.glob2), ylab = "Distance de Cook", xlab = "Observations", main = "Influence des observations")
abline(h = 4/(324-4), lty = 2) #rien en haut de 1, mais un bon nombre sont en haut du seuil
dev.off()
#modèles mixtes----
lme.null <- lme(log10(feeding_success) ~1, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.null)

lme.glob1 <- lme(log10(feeding_success) ~ surf_temp_degC + NASC_zoo + fish_cond + indstandard, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.glob1) #serait mieux d'utiliser une transformation log10


lme.glob2 <- lme(log10(feeding_success) ~ open_water_day + fish_cond, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.glob2)
performance::r2(lme.glob2)


lme.glob3 <- lme(log10(feeding_success) ~ open_water_day + fish_cond +surf_temp_degC + NASC_zoo + indstandard, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.glob3)
performance::r2(lme.glob3)

lme.bu <- lme(log10(feeding_success) ~ open_water_day, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.bu)

lme.cond <- lme(log10(feeding_success) ~ fish_cond, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.cond)

lme.comp <- lme(log10(feeding_success) ~ indstandard, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.comp)

lme.NASC <- lme(log10(feeding_success) ~ NASC_zoo, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.NASC)

lme.temp <- lme(log10(feeding_success) ~ surf_temp_degC, random = ~1|region, data = dfish, na.action = na.omit, method = "ML")
summary(lme.temp)

list.models <- list(null = lme.null, tempNASCFishcond = lme.glob1, buFishcond= lme.glob2, buOnly = lme.bu, tempONLY = lme.temp, condOnly = lme.cond, NASConly = lme.NASC, compONLY = lme.comp)

selection <- AICcmodavg::aictab(list.models)
selection #les deux premiers modèles semblent être ceux qui ont le plus de poids

est.bu <- AICcmodavg::modavg(list.models, "open_water_day")
est.bu
est.fish.cond <- AICcmodavg::modavg(list.models, "fish_cond")
est.fish.cond
est.temp <- AICcmodavg::modavgShrink(list.models, "surf_temp_degC")
est.temp
est.zoo <- AICcmodavg::modavgShrink(list.models, "NASC_zoo")
est.zoo

new.data <- data.frame(
  open_water_day = seq(from = min(dfish$open_water_day), to = max(dfish$open_water_day), length.out = 100),
  fish_cond = mean(dfish$fish_cond),
  region = "Amundsen Gulf Mouth",
  surf_temp_degC = mean(dfish$surf_temp_degC),
  NASC_zoo = mean(dfish$NASC_zoo),
  indstandard = mean(dfish$indstandard)
)
preds <- AICcmodavg::modavgPred(cand.set = list.models, newdata = new.data)
preds2 <- predict(lme.glob2, newdata =new.data)

new.data$fit <- preds$mod.avg.pred
new.data$se <- preds$uncond.se
new.data$low95 <- preds$lower.CL
new.data$supp95 <- preds$upper.CL

#pdf("/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/preds_bu.pdf")
plot(smooth(fit) ~ open_water_day, data = new.data,
     ylab = "log10(Succès alimentaire des jeunes morues polaires)",
     xlab = "Nombre de jours juliens depuis la débâcle",
     main = "Valeurs prédites pondérées de succès alimentaire (+- IC 95%)",
     type = 'l')
lines(x = new.data$open_water_day, y = smooth(new.data$supp95), lty = 'dotted')
lines(x = new.data$open_water_day, y = smooth(new.data$low95), lty = 'dotted')
#dev.off()
```



## Poster RSA

```{r RSA FS OWD, eval = FALSE, echo = FALSE}
# Poster RSA QO
mean_logFS <- aggregate(logFS~ region + open_water_day, data = dfish, FUN = mean)
mean_logFS$region <- ordered(mean_logFS$region, c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "NEG"))

colours <- pals::stepped(n = 24)[c(1,4,9,11,12,13, 15,16,17)]
FS_OWD <- ggplot() +
  geom_point(data = mean_logFS, mapping = aes(x = open_water_day, y = logFS, color = region), size = 10)+
  geom_line(data = new.data, mapping = aes(y = fit, x = open_water_day)) + 
  geom_ribbon(data = new.data, aes(x = open_water_day, y = NULL, ymin = low95, ymax = supp95),
                 alpha = .15) + 
  theme_classic()+
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.position = c(0.25,0.78), 
        axis.text.x = element_text(size=30),
        axis.text.y = element_text(size = 30), 
        legend.text = element_text(size = 22), 
        axis.title = element_text(size = 30), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill="transparent")) + 
  labs(x = "Nombre de jours depuis la débâcle", y = "log10(Succès alimentaire moyen)") + 
  scale_color_manual(values = colours, name = "Région", labels = c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "North-Eastern\nGreenland Sea")) + 
  scale_x_continuous(breaks = c(-20, 0, 20, 40, 60, 80, 100))

FS_OWD
ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/FS_OWD_fish.png", plot = FS_OWD, dpi = 500, width = 14, height = 10, bg = "transparent")




```


```{r RSA distribution proies, eval = FALSE, echo = FALSE}

library(pals)
colours_bar <- pals::stepped(n = 24)[c(20:17, 16:13, 12,5,8,4:1)]

gutcontent2$OWD_cat <- with(gutcontent2, ifelse(open_water_day <= 0, "before_bu",
                                              ifelse(open_water_day >0 & open_water_day <20, "0-20",
                                                     ifelse(open_water_day >=20 & open_water_day<40, "20-40",
                                                            ifelse(open_water_day >=40 & open_water_day <60, "40-60",
                                                                   ifelse(open_water_day >=60 & open_water_day < 80, "60-80", "80+"))))))

freqtable <- as.data.frame(table(gutcontent2$prey_id_comb,gutcontent2$region))
freqtable$Var2 <- ordered(freqtable$Var2, c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "NEG"))
freqtable$Var1 <- ordered(freqtable$Var1, c("appendicularia", "bivalve larvae", "egg", "limacina helicina", "calanoid sp c", "cyclopoidae sp c",  "other copepodite sp", "other copepodite n", "other", "pseudocalanus sp c", "pseudocalanus sp n", "calanus glacialis c", "calanus hyperboreus c", "calanus sp c", "calanus sp n"))


preys_occ <- ggplot() +
  geom_bar(data =freqtable, mapping = aes(fill=Var1, y=Freq, x=Var2), position="fill", stat="identity") +
  ggtitle( "Fréquence d'occurence\ndans la diète")+
   scale_fill_manual(name = "", values =colours_bar, labels = c("Appendicularia", 
                                                    "Bivalvia", 
                                                    "Oeuf", 
                                                    "Gastropoda", 
                                                    "Calanoidae spp.", 
                                                    "Cyclopoidae spp.", 
                                                    "Autre copépodite", 
                                                    "Autre nauplii",
                                                    "Autre type de proies",
                                                    expression(paste(italic("Pseudocalanus "), "spp.", sep = "")),
                                                    expression(paste(italic("Pseudocalanus "), "spp.  Nauplii", sep = "")),
                                                    expression(italic("Calanus glacialis")), 
                                                    expression(italic("Calanus hyperboreus")), 
                                                    expression(paste(italic("Calanus "), "spp.", sep = "")), 
                                                    expression(paste(italic("Calanus "), "spp.  Nauplii", sep = ""))
                                                    ))+ 
  theme_classic() +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size = 20), 
        legend.text = element_text(size = 22),
        legend.text.align = 0,
        axis.title = element_text(size = 25), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        plot.title = element_text(size = 30, hjust = 0.5)) + 
  labs(y = "Proportion", x = "") + 
  scale_x_discrete(labels = c("MS", "AGM", "CM", "LV", "PS", "LS", "NW", "WBB", "NEG"))
preys_occ
#ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/preys_occ.png", plot = preys_occ, dpi = 500, width = 14, height = 10, bg = "transparent")

carbon_input <- aggregate(carbon_mg ~ prey_id_comb + region, data = gutcontent2, FUN = sum)
carbon_input$region <- ordered(carbon_input$region, c("Mackenzie Shelf", "Amundsen Gulf Mouth", "Coronation Maud", "Larsen Sound - Victoria Strait", "Peel Sound", "Lancaster Sound", "North Water", "West Baffin Bay", "NEG"))
carbon_input$prey_id_comb <- ordered(carbon_input$prey_id_comb, c("appendicularia", "bivalve larvae", "egg", "limacina helicina", "calanoid sp c", "cyclopoidae sp c",  "other copepodite sp", "other copepodite n", "other", "pseudocalanus sp c", "pseudocalanus sp n", "calanus glacialis c", "calanus hyperboreus c", "calanus sp c", "calanus sp n"))
preys_carbon <- ggplot() +
  geom_bar(data =carbon_input, mapping = aes(fill=prey_id_comb, y=carbon_mg, x=region), position="fill", stat="identity") +
  ggtitle("Proportion en carbone\ndans la diète")+
   scale_fill_manual(name = "", values =colours_bar, labels = c("Appendicularia", 
                                                    "Bivalvia", 
                                                    "Oeuf", 
                                                    "Gastropoda", 
                                                    "Calanoidae spp.", 
                                                    "Cyclopoidae spp.", 
                                                    "Autre copépodite", 
                                                    "Autre nauplii",
                                                    "Autre type de proies",
                                                    expression(paste(italic("Pseudocalanus "), "spp.", sep = "")),
                                                    expression(paste(italic("Pseudocalanus "), "spp.  Nauplii", sep = "")),
                                                    expression(italic("Calanus glacialis")), 
                                                    expression(italic("Calanus hyperboreus")), 
                                                    expression(paste(italic("Calanus "), "spp.", sep = "")), 
                                                    expression(paste(italic("Calanus "), "spp.  Nauplii", sep = ""))
                                                    )) + 
  theme_classic() +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size = 20), 
        legend.text = element_text(size = 22),
        legend.text.align = 0,
        axis.title = element_text(size = 25), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        plot.title = element_text(size = 30, hjust = 0.5)) + 
  labs(y = "", x = "Région") + 
  scale_x_discrete(labels = c("MS", "AGM", "CM", "LV", "PS", "LS", "NW", "WBB", "NEG"))
preys_carbon

#ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/preys_carbon.png", plot = preys_carbon, dpi = 500, width = 14, height = 10, bg = "transparent")



freqtable3 <- as.data.frame(table(gutcontent2$prey_id_comb,gutcontent2$OWD_cat))
freqtable3$Var1 <- ordered(freqtable3$Var1, c("appendicularia", "bivalve larvae", "egg", "limacina helicina", "calanoid sp c", "cyclopoidae sp c",  "other copepodite sp", "other copepodite n", "other", "pseudocalanus sp c", "pseudocalanus sp n", "calanus glacialis c", "calanus hyperboreus c", "calanus sp c", "calanus sp n"))
freqtable3$Var2 <- ordered(freqtable3$Var2,c("before_bu", "0-20","20-40", "40-60", "60-80", "80+"))


preys_occ_owd <- ggplot() +
  geom_bar(data =freqtable3, mapping = aes(fill=Var1, y=Freq, x=Var2), position="fill", stat="identity") +
  ggtitle( "Fréquence d'occurence\ndes proies dans la diète")+
   scale_fill_manual(name = "", values =colours_bar, labels = c("Appendicularia", 
                                                    "Bivalvia", 
                                                    "Oeuf", 
                                                    "Gastropoda", 
                                                    "Calanoidae spp.", 
                                                    "Cyclopoidae spp.", 
                                                    "Autre copépodite", 
                                                    "Autre nauplii",
                                                    "Autre type de proies",
                                                    expression(paste(italic("Pseudocalanus "), "spp.", sep = "")),
                                                    expression(paste(italic("Pseudocalanus "), "spp. Nauplii", sep = "")),
                                                    expression(italic("Calanus glacialis")), 
                                                    expression(italic("Calanus hyperboreus")), 
                                                    expression(paste(italic("Calanus "), "spp.", sep = "")), 
                                                    expression(paste(italic("Calanus "), "spp. Nauplii", sep = ""))
                                                    ))+ 
  theme_classic() +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        axis.text.x = element_text(size=30),
        axis.text.y = element_text(size = 30), 
        legend.text = element_text(size = 22),
        legend.text.align = 0,
        axis.title = element_text(size = 35), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        plot.title = element_text(size = 35, hjust = 0.5)) + 
  labs(y = "Proportion", x = "Nombre de jours depuis la débâcle")+
  scale_x_discrete(labels = c("Avant\ndébâcle", "0-20 j.", "20-40 j.", "40-60 j.", "60-80 j.", "80+ j."))
preys_occ_owd
ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/preys_OWD.png", plot = preys_occ_owd, dpi = 500, width = 17, height = 14, bg = "transparent")

carbon_input2 <- aggregate(carbon_mg ~ prey_id_comb + OWD_cat + unique_fish_id, data = gutcontent2, FUN = sum)
carbon_input3 <- aggregate(carbon_mg ~ prey_id_comb + OWD_cat, data = carbon_input2, FUN=mean)
carbon_input3$OWD_cat <- ordered(carbon_input3$OWD_cat ,c("before_bu", "0-20","20-40", "40-60", "60-80", "80+"))
carbon_input3$prey_id_comb <- ordered(carbon_input3$prey_id_comb, c("appendicularia", "bivalve larvae", "egg", "limacina helicina", "calanoid sp c", "cyclopoidae sp c",  "other copepodite sp", "other copepodite n", "other", "pseudocalanus sp c", "pseudocalanus sp n", "calanus glacialis c", "calanus hyperboreus c", "calanus sp c", "calanus sp n"))
preys_carbon_OWD <- ggplot() +
  geom_bar(data =carbon_input3, mapping = aes(y=carbon_mg, x=OWD_cat, fill = prey_id_comb), stat="identity") +
  ggtitle("Moyenne de carbone ingéré par poisson\net contribution des proies")+
  scale_fill_manual(name = "", values =colours_bar, labels = c("Appendicularia", 
                                                    "Bivalvia", 
                                                    "Oeuf", 
                                                    "Gastropoda", 
                                                    "Calanoidae spp.", 
                                                    "Cyclopoidae spp.", 
                                                    "Autre copépodite", 
                                                    "Autre nauplii",
                                                    "Autre type de proies",
                                                    expression(paste(italic("Pseudocalanus "), "spp.", sep = "")),
                                                    expression(paste(italic("Pseudocalanus "), "spp. Nauplii", sep = "")),
                                                    expression(italic("Calanus glacialis")), 
                                                    expression(italic("Calanus hyperboreus")), 
                                                    expression(paste(italic("Calanus "), "spp.", sep = "")), 
                                                    expression(paste(italic("Calanus "), "spp. Nauplii", sep = ""))
                                                    ))+ 
  theme_classic() +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        axis.text.x = element_text(size=28),
        axis.text.y = element_text(size = 28), 
        legend.text = element_text(size = 25),
        legend.text.align = 0,
        axis.title = element_text(size = 35), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        plot.title = element_text(size = 35, hjust = 0.5))+
  scale_x_discrete(labels = c("Avant\ndébâcle", "0-20 j.", "20-40 j.", "40-60 j.", "60-80 j.", "80+"))+
  labs(y = "Moyenne de carbone ingéré/poisson (mg)", x = "Nombre de jours depuis la débâcle")
preys_carbon_OWD
ggsave(file="/Users/pascalecaissy/Dropbox/MSc 2019-2020/bosaFS/preys_carbon_OWD.png", plot = preys_carbon_OWD, dpi = 500, width = 17, height = 14, bg = "transparent")
#le faire pour des catégories de succès alimentaire


carbon_input4 <- aggregate(carbon_mg ~ prey_id_comb + open_water_day + unique_fish_id, data = gutcontent2, FUN = sum)
carbon_input5 <- aggregate(carbon_mg ~ prey_id_comb + open_water_day, data = carbon_input4, FUN = mean)
carbon_input6 <- aggregate(carbon_mg ~ open_water_day, data = carbon_input5, FUN = sum)
carbon_input_caspC <- aggregate(carbon_mg ~ open_water_day, 
                                data = carbon_input4[carbon_input5$prey_id_comb %in% 
                                                       c("calanus glacialis c", 
                                                         "calanus hyperboreus c", 
                                                         "calanus sp c"),], FUN = sum)

ggplot()+
  geom_point(data = carbon_input6, mapping = aes(x=open_water_day, y = carbon_mg), color = "black")+
  geom_point(data = carbon_input_caspC, mapping = aes(x=open_water_day, y = carbon_mg), color = "#990F26")+
  geom_smooth(method = "loess", span = 0.75,data = carbon_input6, mapping = aes(x=open_water_day, y = carbon_mg), color = "black", fill = "grey") +
  geom_smooth(method = "loess", span = 0.75, data = carbon_input_caspC, mapping = aes(x=open_water_day, y = carbon_mg), color = "#990F26", fill = "#990F26")+
  theme_classic() +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA),
        axis.text.x = element_text(size=28),
        axis.text.y = element_text(size = 28), 
        legend.text = element_text(size = 22),
        legend.text.align = 0,
        axis.title = element_text(size = 30), 
        legend.title = element_text(size =22),
        legend.background = element_rect(fill=alpha('white', 0.4)),
        plot.title = element_text(size = 30, hjust = 0.5))+
  scale_x_continuous(breaks = c(-20, 0, 20, 40, 60, 80, 100))+
  scale_y_continuous(breaks = c(0,0.25,0.5,0.75,1,1.25))

```

## Code mis de côté

```{r discarded, echo = FALSE, eval = FALSE}

# boxcox2 <- function(x){
#   if(any(x < 0, na.rm  = TRUE)) {
#     pt <- car::powerTransform(x, family = "bcnPower") 
#     lambda <- pt$lambda
#     gamma <- pt$gamma
#     bc <- car::bcnPower(x, lambda, gamma = gamma)
#   } else {pt <- car::powerTransform(x)
#   lambda <- pt$lambda
#   bc <- car::bcPower(x, lambda)}
#   return(bc)
# }
# 
# dfish_transf <- dfish %>% select(-region) %>%
#   mapply(FUN = boxcox2) %>% as.data.frame() %>% mutate(region = fish$region)


# 
# reg <- unique(gutcontent$region)
# bu <- data.frame(region = as.character(reg[1]), year = 2009, CIS_break_up_date = as.Date("2009-07-02"))
# bu <- rbind(bu, data.frame(region = as.character(reg[1]), year = 2010, CIS_break_up_date = as.Date("2010-06-11")))
# bu <- rbind(bu, data.frame(region = as.character(reg[1]), year = 2014, CIS_break_up_date = as.Date("2014-06-25")))
# bu <- rbind(bu, data.frame(region = as.character(reg[1]), year = 2015, CIS_break_up_date = as.Date("2015-06-11")))
# bu <- rbind(bu, data.frame(region = as.character(reg[2]), year = 2010, CIS_break_up_date = as.Date("2010-08-13")))
# bu <- rbind(bu, data.frame(region = as.character(reg[2]), year = 2016, CIS_break_up_date = as.Date("2016-07-30")))
# bu <- rbind(bu, data.frame(region = as.character(reg[2]), year = 2018, CIS_break_up_date = as.Date("2018-08-20")))
# bu <- rbind(bu, data.frame(region = as.character(reg[3]), year = 2010, CIS_break_up_date = as.Date("2010-08-06")))
# bu <- rbind(bu, data.frame(region = as.character(reg[3]), year = 2011, CIS_break_up_date = as.Date("2011-07-30")))
# bu <- rbind(bu, data.frame(region = as.character(reg[3]), year = 2014, CIS_break_up_date = as.Date("2014-09-03")))
# bu <- rbind(bu, data.frame(region = as.character(reg[3]), year = 2015, CIS_break_up_date = as.Date("2015-08-20")))
# bu <- rbind(bu, data.frame(region = as.character(reg[3]), year = 2016, CIS_break_up_date = as.Date("2016-07-30")))
# bu <- rbind(bu, data.frame(region = as.character(reg[4]), year = 2010, CIS_break_up_date = as.Date("2010-07-16")))
# bu <- rbind(bu, data.frame(region = as.character(reg[4]), year = 2011, CIS_break_up_date = as.Date("2011-05-21")))
# bu <- rbind(bu, data.frame(region = as.character(reg[4]), year = 2015, CIS_break_up_date = as.Date("2015-05-28")))
# bu <- rbind(bu, data.frame(region = as.character(reg[4]), year = 2016, CIS_break_up_date = as.Date("2016-06-11")))
# bu <- rbind(bu, data.frame(region = as.character(reg[4]), year = 2017, CIS_break_up_date = as.Date("2017-06-11")))
# bu <- rbind(bu, data.frame(region = as.character(reg[5]), year = 2011, CIS_break_up_date = as.Date("2011-07-16")))
# bu <- rbind(bu, data.frame(region = as.character(reg[5]), year = 2016, CIS_break_up_date = as.Date("2016-07-16")))
# bu <- rbind(bu, data.frame(region = as.character(reg[5]), year = 2017, CIS_break_up_date = as.Date("2017-07-09")))
# bu <- rbind(bu, data.frame(region = as.character(reg[5]), year = 2018, CIS_break_up_date = as.Date("2018-07-23")))
# bu <- rbind(bu, data.frame(region = as.character(reg[6]), year = 2014, CIS_break_up_date = as.Date("2014-06-04")))
# bu <- rbind(bu, data.frame(region = as.character(reg[6]), year = 2015, CIS_break_up_date = as.Date("2015-06-04")))
# bu <- rbind(bu, data.frame(region = as.character(reg[6]), year = 2016, CIS_break_up_date = as.Date("2016-05-14")))
# bu <- rbind(bu, data.frame(region = as.character(reg[6]), year = 2018, CIS_break_up_date = as.Date("2018-06-04")))
# bu <- rbind(bu, data.frame(region = as.character(reg[7]), year = 2015, CIS_break_up_date = as.Date("2015-05-21")))
# bu <- rbind(bu, data.frame(region = as.character(reg[8]), year = 2015, CIS_break_up_date = as.Date("2015-07-23")))
# bu <- rbind(bu, data.frame(region = as.character(reg[8]), year = 2016, CIS_break_up_date = as.Date("2016-07-23")))
# bu <- rbind(bu, data.frame(region = as.character(reg[9]), year = 2017, CIS_break_up_date = as.Date("2017-01-01")))
# 
#  Question 3 Comme Cusa et al.
# 
# FO and %Pi were measured using the following equations:
# FO=(Ni∕N) %Pi=(∑Si∕∑Sti )×100
# in which Ni is the number of stomachs with a given prey i in their stomach
# N is the total number of stomachs excluding empty stomachs.
# Si is the total weight of prey i from all stomachs
# Sti is the total prey weight of all stomachs containing prey i
# 
# ```{r comme Cusa et al 2019}
# dpreys_combTF <- as.data.frame(apply(dpreys_comb[,c(22:42)], MARGIN = 2, FUN = as.logical))
# dpreys_combTF$region <- dpreys_comb$region
# 
# preys <- data.frame(num_stom = colSums(dpreys_combTF[-22]))
# preys <- preys %>% mutate(FO = num_stom/339, 
#                           Si = aggregate(data = gutcontent2, carbon_mg ~ prey_id_comb, FUN = sum)$carbon_mg, 
#                           Sti = 1:21)
# rownames(preys) <- colnames(dpreys_comb[,c(22:42)])
# 
# for(i in rownames(preys)){
#   St <- dpreys_comb$carbon_mg[dpreys_comb[,which(colnames(dpreys_comb) == i)]>0] %>% sum
#   preys[i,]$Sti <- St
# }
# 
# preys$PI_percent <- preys$Si/preys$Sti * 100
# 
# #pour les régions
# dpreys <- aggregate( . ~ region,data = dpreys_combTF, FUN = sum)
# preys_reg <- data.frame(t(dpreys[-1]))
# colnames(preys_reg) <- dpreys[,1]
# tot <- aggregate(unique_fish_id ~ region, data = dpreys_comb, FUN=length)
# 
# FO_reg <- data.frame(row.names = rownames(preys_reg))
# for(i in colnames(preys_reg)){
#   print(i)
#   assign(x = i, preys_reg[,i]/tot[tot$region == i, "unique_fish_id"])
#   FO_reg[,paste(i)] <- get(i)
# }
# 
# Si <- aggregate(data = gutcontent2, carbon_mg ~ prey_id_comb + region, FUN = sum)
# Si <- reshape(Si, direction = "wide", 
#         idvar = "prey_id_comb",
#         timevar = "region")
# Si<- Si[order(Si$prey_id_comb),]
# 
# for(i in rownames(preys)){
#   for(j in colnames(FO_reg)){
#     St <- dpreys_comb$carbon_mg[dpreys_comb[,which(colnames(dpreys_comb) == i)]>0 ] %>% sum
#     print(St)
#   }
```

```{r, eval = FALSE, echo = FALSE}
#histogrammes et autres
hist(aggregate(open_water_day ~ year + region, data = dfish, FUN = mean)$open_water_day)
plot(open_water_day ~ region, data = dfish, las = 2)
plot(open_water_day ~ as.factor(province), data = dfish)
aggregate(open_water_day ~ year + region +sampling_date + bu_date, data = dfish, FUN = mean)
lattice::xyplot(open_water_day ~ as.factor(year)|region, data = dfish)

hist(aggregate(surf_temp_degC ~ year + station, data = dfish, FUN = mean)$surf_temp_degC)
plot(surf_temp_degC ~ region, data = dfish, las = 2) #Beaucoup de variation Mackenzie Self
aggregate(surf_temp_degC ~ year + region +sampling_date + station + NASC_zoo + indstandard + surf_sal_kgm3 + open_water_day + bu_date, data = dfish, FUN = mean) %>% filter(region == "Mackenzie Shelf") 
plot(surf_temp_degC ~ as.factor(province), data = dfish)

lattice::xyplot(surf_temp_degC ~ as.factor(year)|region, data = dfish)

hist(aggregate(NASC_zoo ~ year+region, data = dfish, FUN = mean)$NASC_zoo)
plot(NASC_zoo ~ region, data = dfish, las = 2) #Beaucoup variation MS en 2010
plot(NASC_zoo ~ as.factor(province), data = dfish) #presque pas de zoo en mer du GL, et MS 2010  biaise vraiment la mer de Beaufort

plot(indstandard ~ region, data = dfish, las = 2) #Beaucoup variation LS -> c'est vraiment en 2010 qu'on a un pic
plot(log10(indstandard) ~ region, data = dfish, las = 2)
aggregate(indstandard ~ year + region +sampling_date + station, data = dfish, FUN = mean) %>% filter(region %in% c("Lancaster Sound")) 

plot(surf_sal_kgm3 ~ region, data = dfish, las = 2) #Beaucoup variation CM & PS, oz on a d'ailleurs des salinités assez faibles
lattice::xyplot(surf_sal_kgm3 ~ as.factor(year)|region, data = dfish)
aggregate(surf_sal_kgm3 ~ year + region +sampling_date + station, data = dfish, FUN = mean) %>% filter(region %in% c("Coronation Maud", "Peel Sound")) #2011 PS, 2017 et 2018 CM (QMG1-2-3-M) -> semble dépendre où était située la station QMG -> plus loin vers l'ouest = plus salé

plot(prof_mel ~ region, data = dfish, las = 2) #Beaucoup variation CM & PS, oz on a d'ailleurs des salinités assez faibles
range(dfish$prof_mel)
lattice::xyplot(prof_mel ~ as.factor(year)|region, data = dfish)

```
